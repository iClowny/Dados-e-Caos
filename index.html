<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RPG Emojis 4.0: Dados & Caos</title>

<style>
  :root{
    --bg:#0f172a; --panel:#1e293b; --text:#e2e8f0; --accent:#38bdf8;
    --btn:#334155; --btnHover:#475569; --border:#475569;
    --hp:#ef4444; --mp:#60a5fa; --xp:#22c55e; --gold:#fbbf24;
    --crit:#facc15; --miss:#94a3b8; --dmg:#f87171;
  }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); color:var(--text); font:14px/1.5 system-ui,sans-serif; user-select:none; transition: background 0.5s ease; }
  
  /* Temas de Mapa */
  body.theme-town { background: linear-gradient(to bottom, #1e293b, #0f172a); }
  body.theme-forest { background: linear-gradient(to bottom, #14532d, #052e16); }
  body.theme-dungeon { background: linear-gradient(to bottom, #4c0519, #270610); }
  
  #app{ max-width: 900px; margin: 20px auto; padding: 10px; display:grid; gap:12px; }
  
  /* Utilit√°rios */
  .hidden { display:none !important; }
  .row { display:flex; align-items:center; gap:8px; }
  .between { justify-content:space-between; }
  .btn { background:var(--btn); color:inherit; border:1px solid var(--border); padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:700; transition:0.1s; display:flex; align-items:center; justify-content:center; gap:6px; }
  .btn:hover:not(:disabled) { filter:brightness(1.2); transform:translateY(-2px); }
  .btn:disabled { opacity:0.5; cursor:not-allowed; }
  .btn-big { width:100%; padding:14px; font-size:15px; margin-top:4px; }
  
  /* Layout */
  .header { display:flex; justify-content:space-between; align-items:center; padding:0 4px; }
  .grid-layout { display:grid; grid-template-columns: 260px 1fr 260px; gap:12px; }
  @media (max-width: 850px){ .grid-layout{grid-template-columns: 1fr} }
  
  .panel { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:0 10px 15px -3px rgba(0,0,0,0.3); }
  .title { font-weight:800; border-bottom:1px solid var(--border); margin-bottom:10px; padding-bottom:4px; letter-spacing:0.5px; color:var(--accent); }

  /* Barras */
  .bar-box { background:rgba(0,0,0,0.6); height:14px; border-radius:7px; overflow:hidden; width:100%; margin-top:4px; border:1px solid rgba(255,255,255,0.1); }
  .bar-fill { height:100%; width:0%; transition:width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
  .c-hp { background:var(--hp); } .c-mp { background:var(--mp); } .c-xp { background:var(--xp); }

  /* Tela de Jogo */
  .screen { height:240px; background:rgba(0,0,0,0.4); border-radius:8px; border:1px solid var(--border); display:flex; align-items:center; justify-content:center; flex-direction:column; position:relative; overflow:hidden; }
  .main-emoji { font-size:90px; z-index:2; filter:drop-shadow(0 10px 20px rgba(0,0,0,0.6)); transition:transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  .bg-emoji { position:absolute; font-size:200px; opacity:0.08; z-index:1; animation: pulseBg 6s infinite alternate; }
  @keyframes pulseBg { from{transform:scale(1) rotate(0deg)} to{transform:scale(1.2) rotate(10deg)} }
  
  /* FX e Dice */
  @keyframes diceRoll { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
  .anim-shake { animation: shake 0.4s; }
  @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }
  
  .dmg-pop { position:absolute; font-weight:900; font-size:32px; animation: floatUp 1.2s forwards; z-index:10; text-shadow:0 3px 6px rgba(0,0,0,0.9); pointer-events:none; }
  @keyframes floatUp { 0%{transform:translateY(0) scale(0.5);opacity:0} 15%{opacity:1;transform:translateY(-15px) scale(1.2)} 100%{transform:translateY(-80px) scale(1);opacity:0} }

  /* Logs */
  .log-area { height:160px; overflow-y:auto; background:rgba(0,0,0,0.5); padding:10px; border-radius:6px; font-family:'Courier New', monospace; margin-top:10px; font-size:13px; border:1px solid var(--border); }
  .log-line { margin-bottom:5px; border-bottom:1px dashed rgba(255,255,255,0.1); padding-bottom:3px; }
  .l-crit { color:var(--crit); font-weight:bold; }
  .l-miss { color:var(--miss); font-style:italic; }
  .l-dmg { color:var(--dmg); }

  /* Modais */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); backdrop-filter:blur(5px); display:none; align-items:center; justify-content:center; z-index:100; }
  .modal-box { background:var(--panel); padding:24px; border-radius:16px; width:100%; max-width:480px; border:1px solid var(--border); max-height:90vh; overflow-y:auto; box-shadow:0 25px 50px -12px rgba(0,0,0,0.8); }
  .card-item { background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; cursor:pointer; border:1px solid transparent; margin-bottom:8px; transition:0.2s; }
  .card-item:hover { border-color:var(--accent); background:rgba(255,255,255,0.1); transform:translateX(4px); }
</style>
</head>
<body>

<div id="app">
  <div class="header">
    <div class="row"><span style="font-size:28px">üé≤</span> <div style="line-height:1"><b>RPG Emojis</b><br><small style="color:var(--accent)">Dados & Caos</small></div></div>
    <div class="row">
      <button class="btn" onclick="UI.openModal('inv')">üéí Inv</button>
      <button class="btn" onclick="UI.openModal('map')">üó∫Ô∏è Mapa</button>
      <button class="btn" style="border-color:var(--hp); color:var(--hp)" onclick="Core.resetGame()">‚úï Reset</button>
    </div>
  </div>

  <div class="grid-layout">
    <div class="panel">
      <div class="title row between">
        <span>Ficha</span> 
        <span id="ui-class" style="color:var(--accent); text-transform:uppercase; font-size:11px; border:1px solid var(--accent); padding:2px 6px; border-radius:4px"></span>
      </div>
      <div class="row between" style="margin-bottom:10px">
        <span class="row">‚≠ê Lvl <b id="ui-lvl">1</b></span>
        <span class="row" style="color:var(--gold)">ü™ô <b id="ui-gold">0</b></span>
      </div>
      
      <div>
        <div class="row between"><small>HP (Vida)</small> <small id="ui-hp-txt"></small></div>
        <div class="bar-box"><div id="bar-hp" class="bar-fill c-hp"></div></div>
        
        <div class="row between" style="margin-top:8px"><small>MP (Mana)</small> <small id="ui-mp-txt"></small></div>
        <div class="bar-box"><div id="bar-mp" class="bar-fill c-mp"></div></div>
        
        <div class="row between" style="margin-top:8px"><small>XP (Exp)</small> <small id="ui-xp-txt"></small></div>
        <div class="bar-box"><div id="bar-xp" class="bar-fill c-xp"></div></div>
      </div>

      <div class="title" style="margin-top:24px">Atributos</div>
      <div class="row between" style="font-size:13px; margin-bottom:4px"><span>‚ö° Agilidade</span> <b id="ui-agi">0</b></div>
      <div class="row between" style="font-size:13px; margin-bottom:4px"><span>üéØ Cr√≠tico</span> <b id="ui-crit">0%</b></div>
      
      <div class="title" style="margin-top:16px">Gear</div>
      <div class="row" style="margin-bottom:6px"><span style="width:24px">üó°Ô∏è</span> <span id="ui-wpn" style="font-size:13px">...</span></div>
      <div class="row"><span style="width:24px">üõ°Ô∏è</span> <span id="ui-arm" style="font-size:13px">...</span></div>
    </div>

    <div class="panel">
      <div id="game-screen" class="screen">
        <div id="ui-bg-emoji" class="bg-emoji"></div>
        <div id="ui-main-emoji" class="main-emoji">ü§î</div>
        <div id="turn-indicator" class="hidden" style="position:absolute; top:10px; background:rgba(0,0,0,0.8); padding:4px 12px; border-radius:20px; font-size:12px; font-weight:bold; color:#fff"></div>
      </div>
      <div id="ui-actions" class="grid-layout" style="grid-template-columns:1fr 1fr; margin-top:12px"></div>
      <div id="ui-log" class="log-area"></div>
    </div>

    <div class="panel">
      <div class="title">Localiza√ß√£o</div>
      <div style="text-align:center; padding:15px; background:rgba(0,0,0,0.3); border-radius:8px; border:1px dashed var(--border)">
        <div id="ui-loc-emoji" style="font-size:42px; margin-bottom:5px"></div>
        <div id="ui-loc-name" style="font-weight:900; font-size:18px"></div>
        <div id="ui-loc-desc" style="font-size:12px; opacity:0.7"></div>
      </div>
      <div class="title" style="margin-top:20px">Miss√µes</div>
      <div id="ui-quests" style="display:flex; flex-direction:column; gap:6px"></div>
    </div>
  </div>
</div>

<div id="modal-overlay" class="modal-overlay">
  <div class="modal-box">
    <div class="row between title">
      <span id="modal-title">T√≠tulo</span>
      <button class="btn" onclick="UI.closeModal()">‚úï</button>
    </div>
    <div id="modal-content"></div>
  </div>
</div>

<script>
// --- BANCO DE DADOS (Configura√ß√µes) ---
const DB = {
  // Classes agora definem Agilidade (iniciativa) e Chance de Cr√≠tico (range do dado)
  classes: {
    warrior: { name:'Guerreiro', e:'‚öîÔ∏è', hp:150, mp:20, agi:2, critRange:20, desc:'HP alto, Cr√≠tico normal (20).' },
    rogue:   { name:'Ladino',    e:'üó°Ô∏è', hp:100, mp:40, agi:6, critRange:18, desc:'Muito r√°pido. Cr√≠tico no 18+.' },
    mage:    { name:'Mago',      e:'üîÆ', hp:80,  mp:80, agi:3, critRange:20, desc:'Mana alta. Dano m√°gico.' },
    hunter:  { name:'Ca√ßador',   e:'üèπ', hp:110, mp:30, agi:5, critRange:19, desc:'R√°pido. Dano consistente.' }
  },
  
  // Habilidades
  skills: {
    bash: { name:'Golpe Brutal', cost:5, type:'dmg', dice:8, bonus:4, txt:'esmagou' }, // 1d8 + 4
    stab: { name:'Ponto Vital',  cost:5, type:'dmg', dice:10, bonus:2, txt:'perfurou' },
    fire: { name:'Bola de Fogo', cost:10, type:'dmg', dice:20, bonus:5, txt:'queimou' }, // 1d20 + 5
    shot: { name:'Tiro Duplo',   cost:8, type:'dmg', dice:12, bonus:6, txt:'disparou' },
    heal: { name:'Curar', cost:10, type:'heal', val:40, txt:'se curou' }
  },

  // Mapas
  maps: {
    town:    { name:'Vila',     e:'üèòÔ∏è', lvl:1, theme:'town', type:'safe', desc:'Paz e com√©rcio.' },
    forest:  { name:'Floresta', e:'üå≤', lvl:1, theme:'forest', type:'combat', mobs:['rat','wolf'], desc:'Inimigos Nvl 1-3' },
    cave:    { name:'Caverna',  e:'ü¶á', lvl:3, theme:'dungeon', type:'combat', mobs:['bat','orc'], desc:'Inimigos Nvl 3-5' },
    ruins:   { name:'Ru√≠nas',   e:'üèõÔ∏è', lvl:5, theme:'dungeon', type:'combat', mobs:['skel','demon'], desc:'Inimigos Nvl 5+' }
  },

  // Monstros (agi = iniciativa)
  mobs: {
    rat:  { name:'Rato',      e:'üêÄ', hp:25, agi:1, atk:4,  xp:8,  gold:3 },
    wolf: { name:'Lobo',      e:'üê∫', hp:45, agi:4, atk:6,  xp:15, gold:8 },
    bat:  { name:'Morcego',   e:'ü¶á', hp:35, agi:7, atk:5,  xp:18, gold:6 }, // R√°pido!
    orc:  { name:'Orc',       e:'üëπ', hp:70, agi:2, atk:9,  xp:30, gold:15 },
    skel: { name:'Esqueleto', e:'üíÄ', hp:60, agi:3, atk:10, xp:35, gold:18 },
    demon:{ name:'Dem√¥nio',   e:'üëø', hp:120,agi:5, atk:14, xp:80, gold:50, boss:true }
  },

  // Itens (Armas agora t√™m dano M√≠nimo e M√°ximo)
  items: {
    pot:  { name:'Po√ß√£o Vida', e:'üß™', type:'use', val:15, effect:p=>p.hp=Math.min(p.maxHp, p.hp+50) },
    bomb: { name:'Bomba',      e:'üí£', type:'dmg', val:30, dmg:35 }
  },
  weapons: [
    { name:'Punhos', min:1, max:3 }, 
    { name:'Adaga', min:3, max:6, cost:50 }, 
    { name:'Espada', min:5, max:10, cost:150 }, 
    { name:'Machado', min:8, max:18, cost:400 } // Machado tem dano alto, mas vari√°vel
  ],
  armors: [
    { name:'Camisa', def:0 }, { name:'Couro', def:2, cost:50 }, 
    { name:'Malha', def:5, cost:150 }, { name:'Placas', def:10, cost:400 }
  ],
  
  quests: [
    { id:'q1', target:'rat', count:5, title:'Praga de Ratos', reward:50 },
    { id:'q2', target:'orc', count:3, title:'Invas√£o Orc', reward:150 },
    { id:'q3', target:'demon', count:1, title:'O Chefe', reward:500 }
  ]
};

// --- ESTADO DO JOGO ---
let State = {
  player: { name:'Her√≥i', class:null, lvl:1, xp:0, gold:0, hp:100, mp:50, maxHp:100, maxMp:50, wpn:0, arm:0, inv:{} },
  loc: 'town',
  combat: null,
  questData: {}
};

// --- FUN√á√ïES DE DADOS (DICE) ---
const Dice = {
  d20: () => Math.floor(Math.random() * 20) + 1,
  roll: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
};

// --- INTERFACE (UI) ---
const UI = {
  render: () => {
    const p = State.player;
    const c = DB.classes[p.class];
    
    // Header Info
    document.getElementById('ui-lvl').innerText = p.lvl;
    document.getElementById('ui-gold').innerText = p.gold;
    document.getElementById('ui-class').innerText = c ? c.name : '';
    
    // Bars
    const setBar = (id, cur, max) => {
      document.getElementById(`ui-${id}-txt`).innerText = `${Math.floor(cur)}/${max}`;
      document.getElementById(`bar-${id}`).style.width = Math.min(100, (cur/max)*100) + '%';
    };
    setBar('hp', p.hp, p.maxHp);
    setBar('mp', p.mp, p.maxMp);
    setBar('xp', p.xp, p.lvl*80); // XP curve simplified

    // Stats Panel
    if(c) {
      document.getElementById('ui-agi').innerText = c.agi;
      document.getElementById('ui-crit').innerText = `${21 - c.critRange}/20 (${(21-c.critRange)*5}%)`;
    }
    document.getElementById('ui-wpn').innerText = `${DB.weapons[p.wpn].name} (${DB.weapons[p.wpn].min}-${DB.weapons[p.wpn].max} dmg)`;
    document.getElementById('ui-arm').innerText = `${DB.armors[p.arm].name} (+${DB.armors[p.arm].def} def)`;

    // Quests
    const qBox = document.getElementById('ui-quests');
    qBox.innerHTML = '';
    DB.quests.forEach(q => {
      const cur = State.questData[q.target] || 0;
      const done = cur >= q.count;
      qBox.innerHTML += `
        <div style="font-size:12px; padding:6px; background:rgba(255,255,255,${done?0.05:0.1}); border-left:3px solid ${done?'var(--xp)':'var(--gold)'}; opacity:${done?0.6:1}">
          ${done?'‚úÖ':'‚¨ú'} <b>${q.title}</b>: ${Math.min(cur,q.count)}/${q.count}
        </div>`;
    });
  },

  log: (msg, type='') => {
    const box = document.getElementById('ui-log');
    const div = document.createElement('div');
    div.className = `log-line ${type}`;
    div.innerHTML = msg;
    box.prepend(div);
  },

  fxFloat: (txt, type) => {
    const el = document.createElement('div');
    el.className = 'dmg-pop';
    el.innerHTML = txt;
    el.style.color = type === 'crit' ? 'var(--crit)' : (type === 'miss' ? 'var(--miss)' : '#fff');
    if(type==='playerDmg') el.style.color = 'var(--dmg)';
    
    // Random position
    el.style.left = (30 + Math.random()*40) + '%';
    el.style.top = (30 + Math.random()*20) + '%';
    
    document.getElementById('game-screen').appendChild(el);
    setTimeout(()=>el.remove(), 1200);
  },

  setScreen: (emoji, bg) => {
    document.getElementById('ui-main-emoji').innerText = emoji;
    if(bg) document.getElementById('ui-bg-emoji').innerText = bg;
  },
  
  setTheme: (t) => document.body.className = `theme-${t}`,

  toggleModal: (id) => {
    const m = document.getElementById('modal-overlay');
    m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
  },
  
  openModal: (type) => {
    const content = document.getElementById('modal-content');
    const title = document.getElementById('modal-title');
    document.getElementById('modal-overlay').style.display = 'flex';
    content.innerHTML = '';
    
    if(type === 'class') {
      title.innerText = 'Escolha sua Classe';
      for(let k in DB.classes) {
        const c = DB.classes[k];
        content.innerHTML += `
        <div class="card-item row" onclick="Core.setClass('${k}')">
          <div style="font-size:32px">${c.e}</div>
          <div><b style="color:var(--accent)">${c.name}</b><br><small>${c.desc}</small></div>
        </div>`;
      }
    } 
    else if(type === 'map') {
      title.innerText = 'Viajar';
      for(let k in DB.maps) {
        const m = DB.maps[k];
        const locked = State.player.lvl < m.lvl;
        content.innerHTML += `
        <div class="card-item row between" style="opacity:${locked?0.5:1}" onclick="${locked?'':'Core.travel(\''+k+'\')'}">
          <div class="row"><span style="font-size:24px">${m.e}</span> <b>${m.name}</b></div>
          <small>${locked ? 'Lvl '+m.lvl : 'Viajar ‚ûî'}</small>
        </div>`;
      }
    }
    else if(type === 'inv') {
      title.innerText = 'Mochila';
      let empty = true;
      for(let k in State.player.inv) {
        if(State.player.inv[k] > 0) {
          empty = false;
          const it = DB.items[k];
          content.innerHTML += `
          <div class="card-item row between" onclick="Core.useItem('${k}')">
            <span>${it.e} ${it.name} (x${State.player.inv[k]})</span> <b style="color:var(--accent)">Usar</b>
          </div>`;
        }
      }
      if(empty) content.innerHTML = '<div style="text-align:center; padding:20px; color:#888">Vazio...</div>';
    }
  },
  closeModal: () => document.getElementById('modal-overlay').style.display = 'none'
};

// --- CORE (L√ìGICA) ---
const Core = {
  init: () => {
    const s = localStorage.getItem('rpg_v4_dice');
    if(s) {
      State = JSON.parse(s);
      Core.travel(State.loc);
      UI.log('Bem-vindo de volta, aventureiro.');
    } else {
      UI.openModal('class');
    }
    UI.render();
  },

  save: () => {
    localStorage.setItem('rpg_v4_dice', JSON.stringify(State));
    UI.render();
  },

  resetGame: () => {
    if(confirm('Apagar progresso?')) { localStorage.removeItem('rpg_v4_dice'); location.reload(); }
  },

  setClass: (k) => {
    const c = DB.classes[k];
    State.player.class = k;
    State.player.maxHp = c.hp; State.player.hp = c.hp;
    State.player.maxMp = c.mp; State.player.mp = c.mp;
    State.player.inv = { pot:3 };
    UI.closeModal();
    UI.log(`Voc√™ agora √© um ${c.name}.`);
    Core.travel('town');
  },

  travel: (id) => {
    State.loc = id;
    State.combat = null;
    UI.closeModal();
    const map = DB.maps[id];
    
    UI.setScreen(map.e, map.e);
    UI.setTheme(map.theme);
    document.getElementById('ui-loc-emoji').innerText = map.e;
    document.getElementById('ui-loc-name').innerText = map.name;
    document.getElementById('ui-loc-desc').innerText = map.desc;
    document.getElementById('turn-indicator').classList.add('hidden');

    const area = document.getElementById('ui-actions');
    area.innerHTML = '';
    
    if(map.type === 'safe') {
      area.innerHTML = `
        <button class="btn btn-big" onclick="Core.rest()">üõå Descansar</button>
        <button class="btn btn-big" onclick="Core.openShop()">üí∞ Mercador</button>
        <button class="btn btn-big" onclick="Core.travel('forest')">üå≤ Floresta</button>
      `;
    } else {
      area.innerHTML = `
        <button class="btn btn-big" style="border-color:var(--xp)" onclick="Core.explore()">üé≤ Explorar</button>
        <button class="btn btn-big" onclick="Core.travel('town')">üèÉ Fugir</button>
      `;
    }
    Core.save();
  },

  rest: () => {
    State.player.hp = State.player.maxHp;
    State.player.mp = State.player.maxMp;
    UI.log('Descanso completo. HP/MP restaurados.', 'l-miss');
    UI.fxFloat('üí§', 'miss');
    Core.save();
  },

  explore: () => {
    const map = DB.maps[State.loc];
    // 30% chance de loot, 70% combate
    if(Math.random() < 0.3) {
      const gold = Dice.roll(5, 15) * map.lvl;
      State.player.gold += gold;
      UI.log(`Sorte! Achou ${gold} ouro.`, 'l-crit');
      UI.fxFloat(`+${gold}ü™ô`, 'crit');
      Core.save();
    } else {
      const mobs = map.mobs;
      const mobKey = mobs[Math.floor(Math.random() * mobs.length)];
      Core.startCombat(mobKey);
    }
  },

  // --- COMBATE: DADOS & INICIATIVA ---
  startCombat: (mobKey) => {
    const m = DB.mobs[mobKey];
    State.combat = { enemy: { ...m, maxHp:m.hp }, turn: 0 };
    UI.setScreen(m.e, '‚öîÔ∏è');
    UI.log(`--- COMBATE INICIADO ---`);
    UI.log(`Inimigo: <b>${m.name}</b> (Agi: ${m.agi})`);
    
    // Rola iniciativa
    const pAgi = DB.classes[State.player.class].agi;
    const pInit = Dice.d20() + pAgi;
    const eInit = Dice.d20() + m.agi;
    
    UI.log(`Iniciativa: Voc√™ <b>${pInit}</b> vs ${m.name} <b>${eInit}</b>.`);
    
    if(eInit > pInit) {
      UI.log(`‚ö° ${m.name} √© mais r√°pido e ataca primeiro!`, 'l-dmg');
      setTimeout(() => Core.enemyTurn(true), 1000);
      Core.renderCombatBtns(true); // Bot√µes desativados
    } else {
      UI.log(`‚ö° Voc√™ age primeiro!`);
      Core.renderCombatBtns(false);
    }
  },

  renderCombatBtns: (disabled) => {
    const area = document.getElementById('ui-actions');
    const c = DB.classes[State.player.class];
    const s = DB.skills[Object.keys(DB.classes).find(key => DB.classes[key].name === c.name) ? (c.name==='Guerreiro'?'bash':c.name==='Mago'?'fire':c.name==='Ladino'?'stab':'shot') : 'bash']; 
    // Hack r√°pido pra pegar skill certa, num projeto real seria melhor estruturado
    
    // Skill Map Simples
    let skillKey = 'bash';
    if(State.player.class === 'mage') skillKey = 'fire';
    if(State.player.class === 'rogue') skillKey = 'stab';
    if(State.player.class === 'hunter') skillKey = 'shot';
    
    const skill = DB.skills[skillKey];

    area.innerHTML = `
      <button class="btn btn-big" ${disabled?'disabled':''} onclick="Core.playerAction('atk')">‚öîÔ∏è Atacar</button>
      <button class="btn btn-big" ${disabled?'disabled':''} onclick="Core.playerAction('skill', '${skillKey}')" style="color:var(--mp)">‚ú® ${skill.name} (${skill.cost})</button>
      <button class="btn btn-big" ${disabled?'disabled':''} onclick="UI.openModal('inv')">üéí Item</button>
      <button class="btn btn-big" ${disabled?'disabled':''} onclick="Core.travel('town')">üèÉ Fugir</button>
    `;
    
    const ind = document.getElementById('turn-indicator');
    ind.classList.remove('hidden');
    ind.innerText = disabled ? "TURNO DO INIMIGO" : "SEU TURNO";
    ind.style.background = disabled ? "var(--hp)" : "var(--accent)";
  },

  playerAction: (type, skillKey) => {
    if(!State.combat) return;
    const p = State.player;
    const e = State.combat.enemy;
    const pClass = DB.classes[p.class];
    const wpn = DB.weapons[p.wpn];
    
    // --- ROLAGEM DE ATAQUE (D20) ---
    const hitRoll = Dice.d20();
    let dmg = 0;
    let isCrit = false;
    let msg = "";

    // L√≥gica do Dado
    if(type === 'atk') {
      if(hitRoll === 1) { // Falha Cr√≠tica
        UI.log(`üé≤ 1: FALHA CR√çTICA! Voc√™ trope√ßou.`, 'l-miss');
        p.hp -= 2; // Dano em si mesmo
        UI.fxFloat('OOF!', 'miss');
        UI.render();
      } else {
        // Verifica Cr√≠tico (Baseado na classe)
        if(hitRoll >= pClass.critRange) {
          isCrit = true;
          // Dano: M√°ximo da arma + B√¥nus + Dado Extra
          dmg = wpn.max + 2 + Dice.roll(1,6); 
          dmg = Math.floor(dmg * 1.5); // Multiplicador crit
        } else {
          // Dano Normal: Roll da arma
          dmg = Dice.roll(wpn.min, wpn.max) + Math.floor(p.lvl/2);
        }
        
        e.hp -= dmg;
        msg = `üé≤ ${hitRoll}: Voc√™ causou <b>${dmg}</b> dano${isCrit?' (CR√çTICO!)':''}.`;
        UI.log(msg, isCrit ? 'l-crit' : '');
        UI.fxFloat(dmg, isCrit ? 'crit' : '');
      }
    } 
    else if(type === 'skill') {
      const s = DB.skills[skillKey];
      if(p.mp < s.cost) { UI.log('Sem mana!', 'l-miss'); return; }
      p.mp -= s.cost;
      
      // Skills m√°gicas acertam autom√°tico, mas podem critar no dano
      const skillRoll = Dice.roll(1, s.dice) + s.bonus + (p.lvl);
      dmg = skillRoll;
      if(Dice.d20() === 20) { dmg *= 2; isCrit = true; } // Crit m√°gico raro
      
      e.hp -= dmg;
      UI.log(`‚ú® ${s.name}: ${dmg} dano!`, 'l-crit');
      UI.fxFloat(dmg, 'crit');
    }

    Core.save();

    if(e.hp <= 0) {
      Core.winCombat();
    } else {
      Core.renderCombatBtns(true); // Trava bot√µes
      setTimeout(() => Core.enemyTurn(false), 800);
    }
  },

  enemyTurn: (isSurprise) => {
    if(!State.combat) return;
    const p = State.player;
    const e = State.combat.enemy;
    const armor = DB.armors[p.arm].def;

    // Inimigo rola ataque
    const atkRoll = Dice.d20();
    let dmg = 0;

    if(atkRoll === 1) {
      UI.log(`${e.name} errou o ataque! (üé≤ 1)`, 'l-miss');
      UI.fxFloat('Miss', 'miss');
    } else {
      // Dano base do inimigo + aleat√≥rio(1-4) - Armadura
      let rawDmg = e.atk + Dice.roll(1,4);
      if(atkRoll === 20) { rawDmg *= 2; UI.log(`${e.name} CRITOU! (üé≤ 20)`, 'l-dmg'); }
      
      dmg = Math.max(0, rawDmg - armor);
      p.hp -= dmg;
      if(dmg > 0) {
        if(!isSurprise) UI.log(`${e.name} atacou: ${dmg} dano.`, 'l-dmg');
        UI.fxFloat(`-${dmg}`, 'playerDmg');
        document.getElementById('game-screen').classList.add('anim-shake');
        setTimeout(()=>document.getElementById('game-screen').classList.remove('anim-shake'), 400);
      } else {
        UI.log(`Sua armadura bloqueou o ataque.`, 'l-miss');
      }
    }

    if(p.hp <= 0) {
      UI.log('üíÄ VOC√ä MORREU...', 'l-dmg');
      p.hp = 1; p.gold = Math.floor(p.gold/2);
      Core.travel('town');
    } else {
      Core.renderCombatBtns(false); // Devolve turno
    }
    Core.save();
  },

  winCombat: () => {
    const e = State.combat.enemy;
    UI.log(`üèÜ Vit√≥ria! +${e.xp} XP, +${e.gold} Ouro.`, 'c-xp');
    State.player.gold += e.gold;
    State.player.xp += e.xp;
    
    // Quest Check
    if(!State.questData[e.name.toLowerCase()]) State.questData[State.combat.enemy.id] = (State.questData[State.combat.enemy.id]||0)+1;
    // Simplificado id match
    const qIds = ['rat','wolf','orc','skel','demon'];
    qIds.forEach(id => {
        if(e.e === DB.mobs[id].e) State.questData[id] = (State.questData[id]||0) + 1;
    });

    // Level Up
    if(State.player.xp >= State.player.lvl * 80) {
      State.player.xp = 0;
      State.player.lvl++;
      State.player.maxHp += 15; State.player.hp = State.player.maxHp;
      State.player.maxMp += 10; State.player.mp = State.player.maxMp;
      UI.log(`üÜô LEVEL UP! N√≠vel ${State.player.lvl}!`, 'l-crit');
    }

    State.combat = null;
    UI.setScreen(e.e);
    document.getElementById('ui-main-emoji').style.transform = 'rotate(90deg)';
    setTimeout(() => {
      document.getElementById('ui-main-emoji').style.transform = 'none';
      Core.travel(State.loc);
    }, 1200);
  },

  useItem: (k) => {
    if(State.player.inv[k] > 0) {
      State.player.inv[k]--;
      DB.items[k].effect(State.player);
      UI.log(`Usou ${DB.items[k].name}.`);
      UI.closeModal();
      Core.save();
    }
  },

  openShop: () => {
    const p = State.player;
    const content = document.getElementById('modal-content');
    const title = document.getElementById('modal-title');
    document.getElementById('modal-overlay').style.display = 'flex';
    title.innerText = 'Mercador';
    content.innerHTML = '';

    // Armas e Armaduras (L√≥gica simples de upgrade)
    const nextW = DB.weapons[p.wpn+1];
    if(nextW) {
      content.innerHTML += `<div class="card-item row between" onclick="Core.buy('wpn')"><span>‚öîÔ∏è ${nextW.name} (${nextW.min}-${nextW.max})</span> <b>${nextW.cost}ü™ô</b></div>`;
    }
    const nextA = DB.armors[p.arm+1];
    if(nextA) {
      content.innerHTML += `<div class="card-item row between" onclick="Core.buy('arm')"><span>üõ°Ô∏è ${nextA.name} (+${nextA.def})</span> <b>${nextA.cost}ü™ô</b></div>`;
    }
    content.innerHTML += '<hr style="border-color:#333">';
    // Potions
    content.innerHTML += `<div class="card-item row between" onclick="Core.buy('pot')"><span>üß™ Po√ß√£o (+50hp)</span> <b>15ü™ô</b></div>`;
  },

  buy: (type) => {
    const p = State.player;
    if(type === 'pot') {
      if(p.gold >= 15) { p.gold -= 15; p.inv.pot = (p.inv.pot||0)+1; UI.log('Comprou po√ß√£o.'); Core.openShop(); }
    } else {
      const list = type==='wpn' ? DB.weapons : DB.armors;
      const idx = type==='wpn' ? p.wpn : p.arm;
      const item = list[idx+1];
      if(p.gold >= item.cost) {
        p.gold -= item.cost;
        if(type==='wpn') p.wpn++; else p.arm++;
        UI.log(`Comprou ${item.name}!`);
        Core.openShop();
      }
    }
    Core.save();
  }
};

Core.init();
</script>
</body>
</html>
