
<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#0f172a">
<title>Reflexo e Caos: Mobile v12.5 (Expans√£o)</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
  :root{
    --bg:#0f172a; --panel:#1e293b; --text:#e2e8f0; --accent:#38bdf8;
    --btn:#334155; --btnHover:#475569; --border:#475569;
    --hp:#ef4444; --mp:#60a5fa; --xp:#22c55e; --gold:#fbbf24;
    --crit:#facc15; --miss:#94a3b8; --dmg:#f87171;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
  
  body{ 
    margin:0; background:var(--bg); color:var(--text); 
    font:16px/1.5 system-ui,-apple-system,sans-serif; 
    user-select:none; transition: background 0.8s ease; 
    padding-bottom: 20px; touch-action: manipulation; 
  }
  
  /* Temas */
  body.theme-town { background: linear-gradient(to bottom, #1e293b, #0f172a); }
  body.theme-forest { background: linear-gradient(to bottom, #14532d, #052e16); }
  body.theme-cave { background: linear-gradient(to bottom, #3f2e3e, #1a1a1a); }
  body.theme-graveyard { background: linear-gradient(to bottom, #312e81, #1e1b4b); }
  body.theme-volcano { background: linear-gradient(to bottom, #7f1d1d, #450a0a); }
  body.theme-void { background: linear-gradient(to bottom, #000000, #2d0036); }
  body.theme-frozen { background: linear-gradient(to bottom, #bae6fd, #0284c7); color:#000; } /* Tema claro */
  body.theme-desert { background: linear-gradient(to bottom, #fde047, #ca8a04); color:#000; }
  body.theme-ocean { background: linear-gradient(to bottom, #1e3a8a, #172554); }
  body.theme-heaven { background: linear-gradient(to bottom, #e0f2fe, #ffffff); color:#000; }
  body.theme-hell { background: linear-gradient(to bottom, #450a0a, #000000); }

  #app{ 
    max-width: 1000px; margin: 0 auto; padding: 10px; 
    display:grid; gap:12px; position:relative; 
  }
  
  /* Bot√µes */
  .btn { 
    background:var(--btn); color:inherit; border:1px solid var(--border); 
    padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:700; 
    transition:0.1s; display:flex; align-items:center; justify-content:center; gap:6px; 
    box-shadow:0 4px 0 rgba(0,0,0,0.2); font-size: 14px;
  }
  .btn:active { transform:translateY(2px); box-shadow:0 2px 0 rgba(0,0,0,0.2); }
  .btn:disabled { opacity:0.5; filter:grayscale(1); pointer-events: none; }
  .btn-big { width:100%; padding:18px; font-size:18px; margin-top:8px; }
  .btn-sm { padding:6px 12px; font-size:12px; }
  
  /* Layout */
  .hidden { display:none !important; }
  .row { display:flex; align-items:center; gap:8px; }
  .between { justify-content:space-between; }
  .header { display:flex; justify-content:space-between; align-items:center; padding:10px 4px; }
  
  .grid-layout { display:grid; grid-template-columns: 280px 1fr 280px; gap:16px; }
  @media (max-width: 900px){ 
    .grid-layout { display: flex; flex-direction: column; }
    .panel-center { order: 1; } .panel-left { order: 2; } .panel-right { order: 3; }
    .screen { height: 240px; }
    .main-emoji { font-size: 80px; }
  }
  
  .panel { background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
  .title { font-weight:800; border-bottom:2px solid var(--border); margin-bottom:12px; padding-bottom:6px; letter-spacing:0.5px; color:var(--accent); display:flex; justify-content:space-between; }

  /* Barras */
  .bar-box { background:rgba(0,0,0,0.6); height:18px; border-radius:9px; overflow:hidden; width:100%; margin-top:4px; border:1px solid rgba(255,255,255,0.1); position:relative; }
  .bar-fill { height:100%; width:0%; transition:width 0.4s ease-out; }
  .c-hp { background:linear-gradient(90deg, #991b1b, #ef4444); } 
  .c-mp { background:linear-gradient(90deg, #1e40af, #60a5fa); } 
  .c-xp { background:linear-gradient(90deg, #166534, #22c55e); }

  /* Stats */
  .stat-row { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px dashed rgba(255,255,255,0.1); }
  .stat-btn { background:var(--xp); color:#fff; border:none; width:30px; height:30px; border-radius:8px; font-weight:bold; font-size:18px; }
  .mount-badge { background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; font-size:14px; margin-top:12px; display:flex; align-items:center; gap:12px; border:1px solid var(--gold); }

  /* Tela de Jogo */
  .screen { 
    height:280px; background:rgba(0,0,0,0.4); border-radius:12px; border:1px solid var(--border); 
    display:flex; align-items:center; justify-content:center; flex-direction:column; 
    position:relative; overflow:hidden; backdrop-filter:blur(2px); 
  }
  .main-emoji { font-size:100px; z-index:2; filter:drop-shadow(0 10px 30px rgba(0,0,0,0.7)); transition:transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position:relative; }
  
  .enemy-stats { width:60%; margin-top:10px; z-index:5; text-align:center; transition:opacity 0.3s; opacity:0; }
  .enemy-bar-bg { height:10px; background:#000; border-radius:5px; overflow:hidden; border:1px solid #555; }
  .enemy-bar-fill { height:100%; background:#ef4444; width:100%; transition:width 0.2s; }

  /* DUELO - SISTEMA DE REFLEXO */
  #duel-overlay { 
    position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:2000; 
    display:none; flex-direction:column; align-items:center; justify-content:center; 
    cursor:pointer; user-select:none; -webkit-tap-highlight-color: transparent;
  }
  .reflex-light {
    width: 150px; height: 150px; border-radius: 50%;
    background: #333; border: 5px solid #555;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    margin-bottom: 30px; transition: 0.1s;
  }
  .reflex-light.wait { background: #ef4444; border-color: #991b1b; box-shadow: 0 0 50px #ef4444; animation: pulseRed 0.5s infinite alternate; }
  .reflex-light.go { background: #22c55e; border-color: #166534; box-shadow: 0 0 80px #22c55e; transform: scale(1.1); }
  
  .reflex-msg { font-size: 40px; font-weight: 900; color: #fff; text-transform: uppercase; letter-spacing: 2px; text-align: center; }
  .reflex-sub { font-size: 14px; color: #aaa; margin-top: 10px; }

  @keyframes pulseRed { from{opacity:0.8} to{opacity:1} }
  
  /* FX */
  .dmg-pop { position:absolute; font-weight:900; font-size:40px; animation: floatUp 0.8s forwards; z-index:15; text-shadow:0 4px 8px rgba(0,0,0,1); pointer-events:none; }
  @keyframes floatUp { 0%{transform:translateY(0) scale(0.5);opacity:0} 10%{opacity:1;transform:translateY(-20px) scale(1.2)} 100%{transform:translateY(-120px) scale(1);opacity:0} }

  .log-area { height:150px; overflow-y:auto; background:rgba(0,0,0,0.5); padding:12px; border-radius:12px; font-family:'Courier New', monospace; margin-top:12px; font-size:13px; border:1px solid var(--border); }
  .quest-box { max-height:220px; overflow-y:auto; }
  .quest-card { background:rgba(255,255,255,0.03); border-left:4px solid #555; padding:12px; margin-bottom:8px; font-size:14px; display:flex; align-items:center; justify-content:space-between; border-radius:0 8px 8px 0; }
  .quest-card.active { border-color:var(--accent); background:rgba(56, 189, 248, 0.05); }
  .quest-card.ready { border-color:var(--gold); background:rgba(251, 191, 36, 0.1); animation: pulseQ 1s infinite; }
  .quest-card.done { border-color:var(--xp); opacity:0.5; text-decoration:line-through; }
  @keyframes pulseQ { 0%{box-shadow:inset 0 0 0 transparent} 50%{box-shadow:inset 0 0 10px rgba(251, 191, 36, 0.2)} }

  /* Modais */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.95); backdrop-filter:blur(5px); display:none; align-items:center; justify-content:center; z-index:2000; padding:10px; }
  .modal-box { background:var(--panel); padding:20px; border-radius:20px; width:100%; max-width:500px; border:1px solid var(--border); max-height:90vh; overflow-y:auto; }
  .card-item { background:rgba(255,255,255,0.05); padding:16px; border-radius:12px; cursor:pointer; border:1px solid transparent; margin-bottom:8px; transition:0.2s; display:flex; justify-content:space-between; align-items:center; }
  .card-item:hover { border-color:var(--accent); background:rgba(255,255,255,0.1); }
  
  .tab-menu { display:flex; gap:8px; margin-bottom:12px; }
  .tab-btn { flex:1; padding:12px; background:#111; border:1px solid #444; color:#888; cursor:pointer; text-align:center; border-radius:8px; font-weight:600; }
  .tab-btn.active { background:var(--accent); color:#000; border-color:var(--accent); }
  .rank-row { display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #333; font-size:15px; }
</style>
</head>
<body>

<div id="duel-overlay" onmousedown="Duel.tap()" ontouchstart="Duel.tap(event)">
  <div id="reflex-light" class="reflex-light"></div>
  <div id="reflex-msg" class="reflex-msg">PREPARE-SE...</div>
  <div class="reflex-sub">Toque APENAS quando ficar verde</div>
  <div id="reflex-debug" style="position:absolute; bottom:20px; color:#555; font-size:12px"></div>
</div>

<div id="app">
  <div class="header">
    <div class="row"><span style="font-size:28px">‚ö°</span> <div style="line-height:1.1"><b>Reflexo & Caos</b><br><small style="color:var(--gold); font-size:11px">ONLINE v12.5</small></div></div>
    <div class="row">
      <button class="btn" onclick="Ranking.open()" style="border-color:var(--gold); color:var(--gold)">üèÜ</button>
      <button class="btn" onclick="UI.openModal('inv')">üéí</button>
      <button class="btn" onclick="UI.openModal('map')">üó∫Ô∏è</button>
      <button class="btn" style="border-color:var(--hp); color:var(--hp)" onclick="Core.resetGame()">‚úï</button>
    </div>
  </div>

  <div class="grid-layout">
    <div class="panel panel-center" style="position:relative">
      <div id="game-screen" class="screen">
        <div id="ui-main-emoji" class="main-emoji">ü§î</div>
        <div id="enemy-hud" class="enemy-stats">
          <div class="enemy-bar-bg"><div id="enemy-hp-bar" class="enemy-bar-fill"></div></div>
          <div style="font-size:12px; color:#fff; margin-top:4px; font-weight:bold; text-shadow:0 1px 2px #000">HP INIMIGO</div>
        </div>
      </div>
      
      <div id="ui-actions" class="grid-layout" style="grid-template-columns:1fr 1fr; margin-top:16px; gap:10px; display:grid"></div>
      <div id="ui-log" class="log-area"></div>
    </div>

    <div class="panel panel-left">
      <div class="title">
        <span>Her√≥i</span> 
        <span id="ui-class" style="color:var(--accent); text-transform:uppercase; font-size:11px; border:1px solid var(--accent); padding:2px 6px; border-radius:4px"></span>
      </div>
      <div class="row between" style="margin-bottom:16px; background:rgba(0,0,0,0.3); padding:10px; border-radius:12px">
        <span class="row">‚≠ê Lvl <b id="ui-lvl">1</b></span>
        <span class="row" style="color:var(--gold)">ü™ô <b id="ui-gold">0</b></span>
      </div>
      
      <div style="margin-bottom:20px">
        <div class="bar-box"><div id="bar-hp" class="bar-fill c-hp"></div></div>
        <div class="row between" style="font-size:11px; margin-top:2px; color:#aaa"><span>HP</span><span id="ui-hp-txt"></span></div>
        <div class="bar-box" style="margin-top:8px"><div id="bar-mp" class="bar-fill c-mp"></div></div>
        <div class="row between" style="font-size:11px; margin-top:2px; color:#aaa"><span>MP</span><span id="ui-mp-txt"></span></div>
        <div class="bar-box" style="margin-top:8px"><div id="bar-xp" class="bar-fill c-xp"></div></div>
        <div class="row between" style="font-size:11px; margin-top:2px; color:#aaa"><span>XP</span><span id="ui-xp-txt"></span></div>
      </div>

      <div class="title row between">
        <span>Atributos</span>
        <span id="ui-points" style="font-size:11px; background:var(--xp); padding:4px 8px; border-radius:10px; color:#fff; display:none; font-weight:bold">0 PTS</span>
      </div>
      <div class="stat-row">
        <span>üí™ For√ßa</span>
        <div class="row"><b id="val-str" class="stat-val">0</b> <button class="stat-btn hidden" onclick="Core.addStat('str')">+</button></div>
      </div>
      <div class="stat-row">
        <span>‚ö° Agilidade</span>
        <div class="row"><b id="val-agi" class="stat-val">0</b> <button class="stat-btn hidden" onclick="Core.addStat('agi')">+</button></div>
      </div>
      <div class="stat-row">
        <span>üß† Intelig√™ncia</span>
        <div class="row"><b id="val-int" class="stat-val">0</b> <button class="stat-btn hidden" onclick="Core.addStat('int')">+</button></div>
      </div>
      
      <div id="ui-mount" class="mount-badge hidden">
        <span id="mnt-icon" style="font-size:24px"></span> 
        <div><b id="mnt-name" style="color:var(--gold)"></b><br><small id="mnt-desc" style="color:#aaa"></small></div>
      </div>
      
      <div class="title" style="margin-top:24px">Equipamento</div>
      <div class="row between card-item" style="padding:10px; cursor:default; hover:none">
        <span class="row">üó°Ô∏è <span id="ui-wpn-name" style="font-size:13px">...</span></span>
        <b id="ui-wpn-dmg" style="font-size:12px; color:#aaa">0-0</b>
      </div>
      <div class="row between card-item" style="padding:10px; cursor:default">
        <span class="row">üõ°Ô∏è <span id="ui-arm-name" style="font-size:13px">...</span></span>
        <b id="ui-arm-def" style="font-size:12px; color:#aaa">+0</b>
      </div>
    </div>

    <div class="panel panel-right">
      <div class="title">Local</div>
      <div style="text-align:center; padding:15px; background:rgba(0,0,0,0.3); border-radius:12px; border:1px dashed var(--border)">
        <div id="ui-loc-emoji" style="font-size:48px"></div>
        <div id="ui-loc-name" style="font-weight:900; font-size:20px"></div>
        <div id="ui-loc-desc" style="font-size:13px; opacity:0.7"></div>
      </div>
      <div class="title" style="margin-top:24px">Miss√µes</div>
      <div id="ui-quests" class="quest-box"></div>
    </div>
  </div>
</div>

<div id="modal-overlay" class="modal-overlay">
  <div class="modal-box">
    <div class="row between title">
      <span id="modal-title">T√≠tulo</span>
      <button class="btn" onclick="UI.closeModal()">‚úï</button>
    </div>
    <div id="modal-content"></div>
  </div>
</div>

<script>
// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyDxJ8aF5s-NROpsXgcl6MireHKs9CoRhjM",
  authDomain: "dados-e-caos.firebaseapp.com",
  projectId: "dados-e-caos",
  storageBucket: "dados-e-caos.firebasestorage.app",
  messagingSenderId: "587243973177",
  appId: "1:587243973177:web:4563689b99677ff5903be8",
  measurementId: "G-DS1BVXLZLX"
};

let db = null;
try {
  if(firebaseConfig.apiKey) {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
  }
} catch(e) { console.log("Offline"); }

// --- RANKING ---
const Ranking = {
  open: async () => {
    const ct = document.getElementById('modal-content');
    const tt = document.getElementById('modal-title');
    document.getElementById('modal-overlay').style.display = 'flex';
    tt.innerText = 'üèÜ Ranking Mundial';
    ct.innerHTML = '<div style="text-align:center; padding:30px">Carregando Lendas...</div>';
    
    let scores = [];
    if(db) {
      try {
        const snap = await db.collection("scores").orderBy("lvl", "desc").limit(20).get();
        snap.forEach(doc => scores.push(doc.data()));
      } catch(e) { ct.innerHTML = "Erro ao carregar."; }
    } else {
      scores = [{name:"Bot_Alpha",lvl:50,gold:9999}, {name:"Voc√™ (Offline)",lvl:State.p.lvl,gold:State.p.gold}];
    }

    let html = `<div style="display:flex; flex-direction:column; gap:8px">`;
    if(!db) html += `<div style="text-align:center;color:#f00;font-size:12px">Modo Offline</div>`;
    
    scores.forEach((s, i) => {
      let icon = i===0?'üëë':(i===1?'ü•à':(i===2?'ü•â':'üë§'));
      html += `
        <div class="rank-row">
          <div style="width:30px">${icon}</div>
          <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${s.name}</div>
          <div style="text-align:right">Lvl ${s.lvl} <span style="color:var(--gold); font-size:12px">(${s.gold})</span></div>
        </div>`;
    });
    html += `</div>`;
    html += `<div style="margin-top:20px; border-top:1px solid #444; padding-top:15px; display:flex; gap:10px">
      <input type="text" id="rank-name" maxlength="12" placeholder="Seu Nome" value="${State.p.name}" style="background:#111; color:#fff; border:1px solid #555; padding:12px; flex:1; border-radius:8px">
      <button class="btn" style="background:var(--xp)" onclick="Ranking.save()">Salvar</button>
    </div>`;
    ct.innerHTML = html;
  },
  save: async () => {
    const nick = document.getElementById('rank-name').value || "Unknown";
    State.p.name = nick; Core.save();
    if(db) {
      try {
        await db.collection("scores").add({ name: nick, lvl: State.p.lvl, gold: State.p.gold, date: new Date() });
        alert("Salvo no Ranking!"); Ranking.open();
      } catch(e) { alert("Erro de conex√£o."); }
    } else alert("Salvo (Offline).");
  }
};

// --- DADOS (EXPANDIDO) ---
const DB = {
  classes: {
    warrior: { name:'Guerreiro', e:'‚öîÔ∏è', hp:150, mp:20, str:4, agi:2, int:1, desc:'Resistente.' },
    rogue:   { name:'Ladino',    e:'üó°Ô∏è', hp:110, mp:40, str:2, agi:5, int:2, desc:'Muito R√°pido.' },
    mage:    { name:'Mago',      e:'üîÆ', hp:80,  mp:100,str:1, agi:2, int:5, desc:'M√°gico.' },
    paladin: { name:'Paladino',  e:'üõ°Ô∏è', hp:140, mp:50, str:3, agi:1, int:3, desc:'Defensivo.' }
  },
  maps: {
    town:      { name:'Vila',       e:'üèòÔ∏è', lvl:1,  theme:'town', type:'safe', desc:'Zona Segura.' },
    forest:    { name:'Floresta',   e:'üå≤', lvl:1,  theme:'forest', type:'combat', mobs:['rat','wolf','thief'], desc:'N√≠vel 1-4' },
    cave:      { name:'Caverna',    e:'üï∏Ô∏è', lvl:5,  theme:'cave', type:'combat', mobs:['bat','spider','orc'], desc:'N√≠vel 5-9' },
    graveyard: { name:'Cemit√©rio',  e:'‚ö∞Ô∏è', lvl:10, theme:'graveyard', type:'combat', mobs:['skel','zombie','ghost'], desc:'N√≠vel 10-14' },
    volcano:   { name:'Vulc√£o',     e:'üåã', lvl:15, theme:'volcano', type:'combat', mobs:['imp','golem','dragon'], desc:'N√≠vel 15-19' },
    frozen:    { name:'Tundra',     e:'‚ùÑÔ∏è', lvl:25, theme:'frozen',  type:'combat', mobs:['penguin','bear','yeti'], desc:'N√≠vel 25-29' },
    desert:    { name:'Deserto',    e:'üèúÔ∏è', lvl:30, theme:'desert',  type:'combat', mobs:['snake','mummy','sphinx'], desc:'N√≠vel 30-39' },
    ocean:     { name:'Oceano',     e:'üêô', lvl:40, theme:'ocean',   type:'combat', mobs:['shark','siren','kraken'], desc:'N√≠vel 40-49' },
    heaven:    { name:'C√©u',        e:'‚òÅÔ∏è', lvl:50, theme:'heaven',  type:'combat', mobs:['harpy','angel','zeus'], desc:'N√≠vel 50-59' },
    hell:      { name:'Inferno',    e:'üî•', lvl:60, theme:'hell',    type:'combat', mobs:['demon','cerberus','lucifer'], desc:'N√≠vel 60+' },
    void:      { name:'O Vazio',    e:'üåå', lvl:70, theme:'void',    type:'combat', mobs:['shadow','voidking'], desc:'FIM DE JOGO' }
  },
  mobs: {
    // Basic
    rat:    { name:'Rato',      e:'üêÄ', hp:30,  agi:1, atk:5,  xp:10,  gold:5 },
    wolf:   { name:'Lobo',      e:'üê∫', hp:50,  agi:3, atk:8,  xp:20,  gold:10 },
    thief:  { name:'Bandido',   e:'ü•∑', hp:60,  agi:5, atk:10, xp:30,  gold:18 },
    bat:    { name:'Morcego',   e:'ü¶á', hp:50,  agi:7, atk:8,  xp:35,  gold:12 },
    spider: { name:'Aranha',    e:'üï∑Ô∏è', hp:80,  agi:6, atk:12, xp:50,  gold:22 },
    orc:    { name:'Orc',       e:'üëπ', hp:120, agi:3, atk:16, xp:70,  gold:35 },
    skel:   { name:'Esqueleto', e:'üíÄ', hp:100, agi:4, atk:18, xp:90,  gold:40 },
    zombie: { name:'Zumbi',     e:'üßü', hp:150, agi:2, atk:22, xp:110, gold:45 },
    ghost:  { name:'Fantasma',  e:'üëª', hp:110, agi:9, atk:25, xp:130, gold:55 },
    imp:    { name:'Diabrete',  e:'üëø', hp:140, agi:10,atk:28, xp:160, gold:65 },
    golem:  { name:'Golem',     e:'üóø', hp:300, agi:1, atk:40, xp:250, gold:120 },
    dragon: { name:'Drag√£o',    e:'üêâ', hp:400, agi:8, atk:55, xp:500, gold:400, boss:true },
    
    // Expanded
    penguin:{ name:'Pinguim',   e:'üêß', hp:200, agi:4, atk:35, xp:300, gold:150 },
    bear:   { name:'Urso Polar',e:'üêª', hp:450, agi:3, atk:50, xp:450, gold:200 },
    yeti:   { name:'Yeti',      e:'ü¶ç', hp:600, agi:2, atk:70, xp:600, gold:300 },
    
    snake:  { name:'Naja',      e:'üêç', hp:300, agi:12,atk:50, xp:500, gold:250 },
    mummy:  { name:'M√∫mia',     e:'ü§ï', hp:600, agi:4, atk:60, xp:700, gold:350 },
    sphinx: { name:'Esfinge',   e:'üêà', hp:900, agi:10,atk:80, xp:1000,gold:500, boss:true },
    
    shark:  { name:'Tubar√£o',   e:'ü¶à', hp:800, agi:11,atk:70, xp:900, gold:450 },
    siren:  { name:'Sereia',    e:'üßú', hp:700, agi:14,atk:75, xp:1100,gold:550 },
    kraken: { name:'Kraken',    e:'ü¶ë', hp:1500,agi:8, atk:100,xp:2000,gold:1000, boss:true },
    
    harpy:  { name:'Harpia',    e:'ü¶Ö', hp:900, agi:16,atk:90, xp:1300,gold:600 },
    angel:  { name:'Anjo',      e:'üëº', hp:1200,agi:13,atk:110,xp:1600,gold:800 },
    zeus:   { name:'Deus',      e:'‚ö°', hp:2500,agi:15,atk:150,xp:3000,gold:2000, boss:true },
    
    demon:  { name:'Dem√¥nio',   e:'üë∫', hp:1400,agi:14,atk:130,xp:2000,gold:900 },
    cerberus:{name:'Cerberus',  e:'üêï', hp:2000,agi:12,atk:160,xp:2500,gold:1200 },
    lucifer:{ name:'L√∫cifer',   e:'üòà', hp:4000,agi:18,atk:200,xp:5000,gold:5000, boss:true },

    shadow: { name:'Sombra',    e:'üë§', hp:3000, agi:15,atk:180,xp:4000, gold:2500 },
    voidking:{name:'Rei Vazio', e:'üëë', hp:6666,agi:12,atk:300, xp:9999,gold:9999, boss:true }
  },
  items: {
    pot:  { name:'Po√ß√£o P.', e:'üß™', val:25, effect:p=>p.hp=Math.min(p.maxHp, p.hp+60), desc:'+60 HP' },
    mega: { name:'Mega Po√ß√£o',e:'üç∑', val:100, effect:p=>p.hp=Math.min(p.maxHp, p.hp+150), desc:'+150 HP' },
    elixir:{ name:'Elixir',   e:'üåü', val:300, effect:p=>{p.hp=p.maxHp;p.mp=p.maxMp}, desc:'FULL HP/MP' },
    ether:{ name:'√âter Mana', e:'üî∑', val:25, effect:p=>p.mp=Math.min(p.maxMp, p.mp+40), desc:'+40 MP' },
    bomb: { name:'Bomba',     e:'üí£', val:50, dmg:50, desc:'50 Dano Fixo' }
  },
  gear: {
    weapons: {
      warrior: [{n:'Punhos',v:1,x:3},{n:'Espada Velha',v:5,x:8,c:100},{n:'Espada Ferro',v:10,x:15,c:350},{n:'Montante',v:15,x:25,c:900},{n:'Matadora',v:25,x:40,c:2500},{n:'Excalibur',v:50,x:70,c:8000},{n:'L√¢mina Gelo',v:80,x:100,c:15000},{n:'Espada Divina',v:120,x:150,c:30000},{n:'Ragnarok',v:200,x:300,c:99999}],
      rogue:   [{n:'Punhos',v:1,x:3},{n:'Adaga Cega',v:4,x:7,c:100},{n:'Adaga Dupla',v:8,x:14,c:350},{n:'L√¢mina Sombra',v:12,x:22,c:900},{n:'Presa Veneno',v:20,x:35,c:2500},{n:'Fim dos Dias',v:45,x:65,c:8000},{n:'Garras Urso',v:70,x:90,c:15000},{n:'Adaga Luz',v:110,x:140,c:30000},{n:'Ceifadora',v:190,x:280,c:99999}],
      mage:    [{n:'M√£os',v:1,x:3},{n:'Varinha Pau',v:4,x:8,c:100},{n:'Cajado Aprendiz',v:8,x:14,c:350},{n:'Cajado R√∫nico',v:14,x:24,c:900},{n:'Cetro Vazio',v:22,x:38,c:2500},{n:'Cosmos',v:48,x:68,c:8000},{n:'Cajado Gelo',v:75,x:95,c:15000},{n:'Cetro Anjo',v:115,x:145,c:30000},{n:'Apocalipse',v:210,x:310,c:99999}],
      paladin: [{n:'Punhos',v:1,x:3},{n:'Ma√ßa Madeira',v:4,x:7,c:100},{n:'Martelo Ferro',v:9,x:14,c:350},{n:'Mangual',v:13,x:23,c:900},{n:'Martelo Luz',v:23,x:38,c:2500},{n:'Mjolnir',v:48,x:68,c:8000},{n:'Estrela Manh√£',v:75,x:100,c:15000},{n:'Justi√ßa',v:115,x:150,c:30000},{n:'Deus Ex',v:200,x:300,c:99999}]
    },
    armors: {
      warrior: [{n:'Camisa',v:0},{n:'Couro Batido',v:3,c:100},{n:'Cota Malha',v:7,c:350},{n:'Peitoral A√ßo',v:14,c:900},{n:'Placas Drag√£o',v:22,c:2500},{n:'Armadura Deus',v:35,c:8000},{n:'Gelo Eterno',v:50,c:15000},{n:'Placas Sol',v:70,c:30000},{n:'Caos Absoluto',v:100,c:99999}],
      rogue:   [{n:'Camisa',v:0},{n:'Capa Viagem',v:2,c:100},{n:'Couro Fino',v:6,c:350},{n:'Manto Sombra',v:12,c:900},{n:'Traje Ninja',v:20,c:2500},{n:'Vulto',v:32,c:8000},{n:'Pele Yeti',v:45,c:15000},{n:'Vento Divino',v:65,c:30000},{n:'Sombra Eterna',v:95,c:99999}],
      mage:    [{n:'Camisa',v:0},{n:'T√∫nica Velha',v:1,c:100},{n:'Robe Aprendiz',v:5,c:350},{n:'Manto Arcano',v:10,c:900},{n:'Toga Estelar',v:18,c:2500},{n:'Tecido Tempo',v:30,c:8000},{n:'Manto Nevasca',v:42,c:15000},{n:'Aura Santa',v:60,c:30000},{n:'Vazio Puro',v:90,c:99999}],
      paladin: [{n:'Camisa',v:0},{n:'Gib√£o',v:3,c:100},{n:'Escudo Torre',v:8,c:350},{n:'Armadura Bento',v:15,c:900},{n:'Placas Luz',v:24,c:2500},{n:'√âgide',v:38,c:8000},{n:'Parede Gelo',v:55,c:15000},{n:'Escudo F√©',v:75,c:30000},{n:'Imortalidade',v:110,c:99999}]
    }
  },
  quests: [
    { id:'q1', target:'rat', count:5, title:'Dedetiza√ß√£o', reward_g:100, reward_xp:100 },
    { id:'q2', target:'wolf', count:10, title:'Ca√ßa Lobos', reward_g:200, reward_xp:250 },
    { id:'q3', target:'orc', count:8, title:'Limpeza', reward_g:400, reward_xp:500 },
    { id:'q4', target:'skel', count:15, title:'Quebra-Ossos', reward_g:800, reward_xp:1000 },
    { id:'q5', target:'golem', count:5, title:'Pedras', reward_g:2000, reward_xp:2500 },
    { id:'q6', target:'dragon', count:1, title:'Matador', reward_g:5000, reward_xp:5000 },
    { id:'q7', target:'penguin', count:10, title:'Pinguins!', reward_g:3000, reward_xp:3000 },
    { id:'q8', target:'yeti', count:5, title:'Abomin√°vel', reward_g:5000, reward_xp:5000 },
    { id:'q9', target:'snake', count:15, title:'Veneno', reward_g:7000, reward_xp:7000 },
    { id:'q10', target:'sphinx', count:3, title:'Enigma', reward_g:10000, reward_xp:10000 },
    { id:'q11', target:'kraken', count:1, title:'Lula Gigante', reward_g:15000, reward_xp:15000 },
    { id:'q12', target:'angel', count:10, title:'Ca√≠do', reward_g:20000, reward_xp:20000 },
    { id:'q13', target:'zeus', count:1, title:'Deic√≠dio', reward_g:30000, reward_xp:30000 },
    { id:'q14', target:'demon', count:20, title:'Expurgo', reward_g:40000, reward_xp:40000 },
    { id:'q15', target:'lucifer', count:1, title:'O Diabo', reward_g:100000, reward_xp:100000 }
  ],
  skills: {
    bash: { name:'Golpe', cost:5, bonus:5, dice:8 },
    stab: { name:'Furar', cost:5, bonus:3, dice:10 },
    fire: { name:'Fogo',  cost:10, bonus:8, dice:20 },
    heal: { name:'Cura',  cost:12, val:50, type:'heal' }
  },
  mounts: {
    horse: { name:'Cavalo', e:'üêé', cost:200, agi:2, str:0, desc:'+2 AGI' },
    wolf:  { name:'Warg',   e:'üê∫', cost:600, agi:4, str:2, desc:'+4 AGI, +2 FOR' },
    griff: { name:'Grifo',  e:'ü¶Ö', cost:1500, agi:6, str:3, int:3, desc:'+6 AGI/FOR/INT' },
    dragon:{ name:'Draco',  e:'üêâ', cost:5000, agi:10, str:8, int:5, desc:'+10 AGI/FOR' },
    ufo:   { name:'OVNI',   e:'üõ∏', cost:50000, agi:20, str:10, int:10, desc:'+20 AGI/EXTREMO' }
  }
};

let State = {
  p: { name:'Her√≥i', class:null, lvl:1, xp:0, gold:0, hp:100, mp:50, maxHp:100, maxMp:50, wpn:0, arm:0, inv:{}, str:1, agi:1, int:1, points:0, mount:null },
  loc: 'town',
  combat: null,
  q: {}
};

const Dice = {
  roll: (min, max) => Math.floor(Math.random()*(max-min+1))+min
};

const getStats = () => {
  const p = State.p;
  let s = { str:p.str, agi:p.agi, int:p.int };
  if(p.mount && DB.mounts[p.mount]) {
    const m = DB.mounts[p.mount];
    s.str += (m.str||0); s.agi += (m.agi||0); s.int += (m.int||0);
  }
  return s;
};

const getGear = () => {
  const p = State.p;
  const c = p.class || 'warrior';
  const w = DB.gear.weapons[c][p.wpn] || DB.gear.weapons[c][DB.gear.weapons[c].length-1];
  const a = DB.gear.armors[c][p.arm] || DB.gear.armors[c][DB.gear.armors[c].length-1];
  return { w, a };
};

// --- LOGICA DE REFLEXO ---
const Duel = {
  state: 'closed', // closed, wait, go, result
  timer: null,
  startTimestamp: 0,
  action: null, // {type, skKey}

  start: (type, skKey) => {
    Duel.action = {type, skKey};
    Duel.state = 'wait';
    
    const ol = document.getElementById('duel-overlay');
    const light = document.getElementById('reflex-light');
    const msg = document.getElementById('reflex-msg');
    
    ol.style.display = 'flex';
    light.className = 'reflex-light wait';
    msg.innerText = "ESPERE...";
    msg.style.color = "#fff";
    
    // --- TEMPO MAIS R√ÅPIDO APLICADO AQUI ---
    const delay = Dice.roll(500, 1500); // 0.5s a 1.5s
    
    Duel.timer = setTimeout(() => {
      Duel.go();
    }, delay);
  },

  go: () => {
    if(Duel.state !== 'wait') return;
    Duel.state = 'go';
    Duel.startTimestamp = Date.now();
    
    const light = document.getElementById('reflex-light');
    const msg = document.getElementById('reflex-msg');
    
    light.className = 'reflex-light go';
    msg.innerText = "AGORA!";
    msg.style.color = "#22c55e";

    // Auto fail if user sleeps
    Duel.timer = setTimeout(() => {
      if(Duel.state === 'go') Duel.resolve(false, 'slow');
    }, 2000); 
  },

  tap: (e) => {
    if(e) e.preventDefault(); // prevent double firing
    if(Duel.state === 'wait') {
      clearTimeout(Duel.timer);
      Duel.resolve(false, 'early');
    } else if(Duel.state === 'go') {
      clearTimeout(Duel.timer);
      Duel.resolve(true, 'hit');
    }
  },

  resolve: (success, reason) => {
    Duel.state = 'result';
    const msg = document.getElementById('reflex-msg');
    const reactTime = Date.now() - Duel.startTimestamp;
    
    const pAgi = getStats().agi;
    const eAgi = State.combat.e.agi;
    
    // CALCULO DA JANELA DE TEMPO (O segredo do balanceamento)
    // Base 800ms. -20ms por Agi Inimigo. +10ms por Agi Player.
    let allowedTime = Math.max(200, 800 - (eAgi * 25) + (pAgi * 10));
    
    if(reason === 'early') {
      msg.innerText = "QUEIMOU!";
      msg.style.color = "#ef4444";
      setTimeout(() => Core.finishTurn(false, 'early'), 800);
    } 
    else if(reason === 'slow') {
      msg.innerText = "LENTO!";
      msg.style.color = "#ef4444";
      setTimeout(() => Core.finishTurn(false, 'slow'), 800);
    }
    else {
      // Hit logic check
      if(reactTime <= allowedTime) {
        msg.innerText = `${reactTime}ms (BOM!)`;
        msg.style.color = "#22c55e";
        setTimeout(() => Core.finishTurn(true, 'hit'), 800);
      } else {
        msg.innerText = `${reactTime}ms (LENTO)`;
        msg.style.color = "#ef4444";
        setTimeout(() => Core.finishTurn(false, 'slow'), 800);
      }
    }
  },
  
  close: () => {
    document.getElementById('duel-overlay').style.display = 'none';
    clearTimeout(Duel.timer);
    Duel.state = 'closed';
  }
};

const UI = {
  render: () => {
    const p = State.p;
    const c = DB.classes[p.class];
    const stats = getStats();
    const g = getGear();
    
    document.getElementById('ui-lvl').innerText = p.lvl;
    document.getElementById('ui-gold').innerText = p.gold;
    document.getElementById('ui-class').innerText = c ? c.name : '';
    
    document.getElementById('val-str').innerText = stats.str;
    document.getElementById('val-agi').innerText = stats.agi;
    document.getElementById('val-int').innerText = stats.int;
    
    const mBadge = document.getElementById('ui-mount');
    if(p.mount) {
      const m = DB.mounts[p.mount];
      document.getElementById('mnt-icon').innerText = m.e;
      document.getElementById('mnt-name').innerText = m.name;
      document.getElementById('mnt-desc').innerText = m.desc;
      mBadge.classList.remove('hidden');
    } else mBadge.classList.add('hidden');
    
    const ptsBtn = document.querySelectorAll('.stat-btn');
    const ptsBadge = document.getElementById('ui-points');
    if(p.points > 0) {
      ptsBadge.innerText = `+${p.points} PTS`;
      ptsBadge.style.display = 'block';
      ptsBtn.forEach(b => b.classList.remove('hidden'));
    } else {
      ptsBadge.style.display = 'none';
      ptsBtn.forEach(b => b.classList.add('hidden'));
    }

    const setBar = (id, cur, max) => {
      document.getElementById(`ui-${id}-txt`).innerText = `${Math.floor(cur)}/${max}`;
      document.getElementById(`bar-${id}`).style.width = Math.min(100, (cur/max)*100) + '%';
    };
    setBar('hp', p.hp, p.maxHp);
    setBar('mp', p.mp, p.maxMp);
    setBar('xp', p.xp, p.lvl*150);

    document.getElementById('ui-wpn-name').innerText = g.w.n;
    document.getElementById('ui-wpn-dmg').innerText = `${g.w.v}-${g.w.x}`;
    document.getElementById('ui-arm-name').innerText = g.a.n;
    document.getElementById('ui-arm-def').innerText = `+${g.a.v}`;

    const hud = document.getElementById('enemy-hud');
    if(State.combat) {
      hud.style.opacity = '1';
      const e = State.combat.e;
      const pct = Math.max(0, Math.min(100, (e.hp/e.maxHp)*100));
      document.getElementById('enemy-hp-bar').style.width = pct + '%';
    } else hud.style.opacity = '0';

    const qBox = document.getElementById('ui-quests');
    qBox.innerHTML = '';
    DB.quests.forEach(q => {
      const cur = State.q[q.target] || 0; 
      const claimed = cur === 'done';
      const val = claimed ? q.count : cur;
      const ready = !claimed && val >= q.count;
      
      let html = `<div class="quest-card ${claimed?'done':(ready?'ready':'')}">`;
      html += `<div><span>${claimed?'‚úÖ':(ready?'‚≠ê':'‚¨ú')} <b>${q.title}</b></span><br><small>(${DB.mobs[q.target].e}) ${Math.min(val,q.count)}/${q.count}</small></div>`;
      if(ready) html += `<button class="btn btn-sm" style="background:var(--gold);color:#000" onclick="Core.claimQuest('${q.id}')">PEGAR</button>`;
      html += `</div>`;
      qBox.innerHTML += html;
    });
  },

  log: (msg, type='') => {
    const box = document.getElementById('ui-log');
    const div = document.createElement('div');
    div.innerHTML = `> ${msg}`;
    div.style.color = type.includes('hp')?'#f87171':(type.includes('xp')?'#4ade80':'#ccc');
    box.prepend(div);
  },

  fxFloat: (txt, type) => {
    const el = document.createElement('div');
    el.className = 'dmg-pop'; el.innerHTML = txt;
    el.style.color = type==='crit'?'var(--crit)':(type==='miss'?'#888':(type==='bad'?'var(--hp)':'#fff'));
    el.style.left = (30 + Math.random()*40) + '%';
    el.style.top = (30 + Math.random()*20) + '%';
    document.getElementById('game-screen').appendChild(el);
    setTimeout(()=>el.remove(), 1000);
  },

  setScreen: (emoji) => {
    document.getElementById('ui-main-emoji').innerText = emoji;
  },
  
  openModal: (type) => {
    const ct = document.getElementById('modal-content');
    const tt = document.getElementById('modal-title');
    document.getElementById('modal-overlay').style.display = 'flex';
    ct.innerHTML = '';
    
    if(type === 'class') {
      tt.innerText = 'Classe';
      for(let k in DB.classes) {
        const c = DB.classes[k];
        ct.innerHTML += `<div class="card-item" onclick="Core.setClass('${k}')">
          <div class="row"><span style="font-size:32px">${c.e}</span> <div><b>${c.name}</b><br><small>${c.desc}</small></div></div>
        </div>`;
      }
    } 
    else if(type === 'map') {
      tt.innerText = 'Viajar';
      for(let k in DB.maps) {
        const m = DB.maps[k];
        const locked = State.p.lvl < m.lvl;
        ct.innerHTML += `<div class="card-item" style="opacity:${locked?0.5:1}" onclick="${locked?'':'Core.travel(\''+k+'\')'}">
          <div class="row"><span style="font-size:24px">${m.e}</span> <div><b>${m.name}</b><br><small>${m.desc}</small></div></div>
          ${locked ? '<small>üîí Nvl '+m.lvl+'</small>' : '<b>IR</b>'}
        </div>`;
      }
    }
    else if(type === 'inv') {
      tt.innerText = 'Mochila';
      for(let k in State.p.inv) {
        if(State.p.inv[k]>0) {
          const it = DB.items[k];
          ct.innerHTML += `<div class="card-item" onclick="Core.useItem('${k}')">
            <span>${it.e} ${it.name} (x${State.p.inv[k]})</span> <b>USAR</b>
          </div>`;
        }
      }
      if(!ct.innerHTML) ct.innerHTML = '<div style="text-align:center;color:#666">Vazio.</div>';
    }
    else if(type === 'reward') {
      tt.innerText = 'Vit√≥ria!';
      ct.innerHTML = `<div style="text-align:center">
        <div style="font-size:60px">üéÅ</div>
        <h3>Recompensa</h3>
        <div style="font-size:24px; color:var(--gold); margin:10px">ü™ô ${State.tempReward.g}</div>
        <div style="font-size:24px; color:var(--xp); margin:10px">‚ú® ${State.tempReward.x} XP</div>
        <button class="btn btn-big" onclick="UI.closeModal()">OK!</button>
      </div>`;
    }
  },
  closeModal: () => document.getElementById('modal-overlay').style.display = 'none'
};

const Core = {
  init: () => {
    const s = localStorage.getItem('rpg_v12_5_expand');
    if(s) { State = JSON.parse(s); Core.travel(State.loc); UI.log('Retornou.'); } 
    else { UI.openModal('class'); }
    UI.render();
  },
  save: () => { localStorage.setItem('rpg_v12_5_expand', JSON.stringify(State)); UI.render(); },
  resetGame: () => { if(confirm('Resetar?')){ localStorage.removeItem('rpg_v12_5_expand'); location.reload(); } },

  setClass: (k) => {
    const c = DB.classes[k];
    State.p.class = k;
    Object.assign(State.p, { maxHp:c.hp, hp:c.hp, maxMp:c.mp, mp:c.mp, str:c.str, agi:c.agi, int:c.int, mount:null, wpn:0, arm:0 });
    State.p.inv = { pot:3 };
    UI.closeModal(); Core.travel('town');
  },

  addStat: (stat) => {
    if(State.p.points > 0) {
      State.p[stat]++; State.p.points--;
      if(stat==='int') State.p.maxMp += 10;
      UI.log(`+1 ${stat.toUpperCase()}`);
      Core.save();
    }
  },

  travel: (id) => {
    State.loc = id; State.combat = null;
    UI.closeModal();
    const map = DB.maps[id];
    UI.setScreen(map.e);
    document.body.className = `theme-${map.theme}`;
    document.getElementById('ui-loc-emoji').innerText = map.e;
    document.getElementById('ui-loc-name').innerText = map.name;
    document.getElementById('ui-loc-desc').innerText = map.desc;
    
    const area = document.getElementById('ui-actions');
    area.innerHTML = '';
    
    if(map.type === 'safe') {
      area.innerHTML = `
        <button class="btn btn-big" onclick="Core.rest()">üõå Dormir</button>
        <button class="btn btn-big" onclick="Core.openShop()">üí∞ Loja</button>
        <button class="btn btn-big" style="border-color:var(--xp)" onclick="UI.openModal('map')">üó∫Ô∏è Viajar</button>
      `;
    } else {
      area.innerHTML = `
        <button class="btn btn-big" onclick="Core.explore()">üé≤ Explorar</button>
        <button class="btn btn-big" onclick="Core.travel('town')">üèÉ Fugir</button>
      `;
    }
    Core.save();
  },

  rest: () => {
    State.p.hp = State.p.maxHp; State.p.mp = State.p.maxMp;
    UI.log('HP/MP Cheios.', 'hp'); Core.save();
  },

  explore: () => {
    const map = DB.maps[State.loc];
    if(Math.random() < 0.20) { 
      const g = Dice.roll(2, 6) * map.lvl;
      State.p.gold += g;
      UI.log(`Achou ${g} ouro.`, 'crit');
      UI.fxFloat(`+${g}ü™ô`, 'crit');
      Core.save();
    } else {
      const mobs = map.mobs;
      const key = mobs[Math.floor(Math.random()*mobs.length)];
      Core.startCombat(key);
    }
  },

  startCombat: (key) => {
    const m = DB.mobs[key];
    State.combat = { e: { ...m, maxHp:m.hp }, turn: 0 };
    UI.setScreen(m.e);
    UI.log(`VS <b>${m.name}</b>`, 'hp');
    Core.renderBtns(false);
  },

  renderBtns: (disabled) => {
    const area = document.getElementById('ui-actions');
    let sk = 'bash';
    if(State.p.class === 'rogue') sk = 'stab';
    if(State.p.class === 'mage') sk = 'fire';
    if(State.p.class === 'paladin') sk = 'heal';
    const sData = DB.skills[sk];

    area.innerHTML = `
      <button class="btn btn-big" ${disabled?'disabled':''} onclick="Core.act('atk')">‚öîÔ∏è Duelo</button>
      <button class="btn btn-big" ${disabled?'disabled':''} onclick="Core.act('skill','${sk}')" style="color:var(--mp)">‚ú® ${sData.name}</button>
      <button class="btn btn-big" ${disabled?'disabled':''} onclick="UI.openModal('inv')">üéí Item</button>
      <button class="btn btn-big" ${disabled?'disabled':''} onclick="Core.travel('town')">üèÉ Fugir</button>
    `;
  },

  act: (type, skKey) => {
    if(!State.combat) return;
    const p = State.p;
    
    // Check mana first
    if(type === 'skill') {
      if(p.mp < DB.skills[skKey].cost) { UI.log('Sem mana!'); return; }
    }
    
    // Start Reflex Duel
    Duel.start(type, skKey);
  },

  finishTurn: (playerWin, reason) => {
    Duel.close();
    const p = State.p;
    const e = State.combat.e;
    const gear = getGear();
    const stats = getStats();
    const action = Duel.action;

    if(playerWin) {
      if(action.type === 'atk') {
        let attr = p.class === 'mage' ? stats.int : stats.str;
        let dmg = Dice.roll(gear.w.v, gear.w.x) + attr + Math.floor(p.lvl/2);
        if(Math.random() > 0.9) { dmg = Math.floor(dmg*1.5); UI.fxFloat('CRIT!','crit'); }
        e.hp -= dmg;
        UI.log(`Hit: <b>${dmg}</b>`);
        UI.fxFloat(dmg, '#fff');
      } 
      else if(action.type === 'skill') {
        p.mp -= DB.skills[action.skKey].cost; // consume mana
        const s = DB.skills[action.skKey];
        if(s.type === 'heal') {
          let heal = s.val + (stats.int * 2);
          p.hp = Math.min(p.maxHp, p.hp + heal);
          UI.log(`Cura: ${heal}`);
          UI.fxFloat('‚ù§','crit');
        } else {
          let base = Dice.roll(1, s.dice) + s.bonus + (stats.int * 2);
          e.hp -= base;
          UI.log(`Magia: <b>${base}</b>`);
          UI.fxFloat(base,'var(--mp)');
        }
      }
    } else {
      // Enemy Turn
      let txt = reason === 'early' ? 'Queimou!' : 'Lento demais!';
      UI.log(txt, 'hp');
      
      const armor = gear.a.v;
      let dmg = Math.max(0, (e.atk + Dice.roll(-2, 2)) - armor);
      if(reason === 'early') dmg = Math.floor(dmg * 1.5);

      p.hp -= dmg;
      if(dmg > 0) UI.fxFloat(`-${dmg}`,'bad');
      else UI.fxFloat('üõ°Ô∏è','miss');
    }

    if(e.hp <= 0) Core.win();
    else if(p.hp <= 0) {
      UI.log('Derrotado...', 'hp');
      p.hp = 1; p.gold = Math.floor(p.gold/2);
      Core.travel('town');
    }
    Core.save();
  },

    win: () => {
    const e = State.combat.e;
    UI.log(`Vit√≥ria! +${e.gold}g`, 'xp');
    State.p.gold += e.gold;
    State.p.xp += e.xp;
    
    // Checa miss√µes
    let key = Object.keys(DB.mobs).find(k => DB.mobs[k].name === e.name);
    if(key && State.q[key] !== 'done') {
      State.q[key] = (State.q[key]||0) + 1;
    }

    // --- L√ìGICA DE LEVEL UP ATUALIZADA ---
    // Agora usamos "while" (enquanto) em vez de "if"
    let leveled = false;
    while(State.p.xp >= State.p.lvl * 150) {
      State.p.xp -= State.p.lvl * 150; // Subtrai o custo e guarda a sobra
      State.p.lvl++;
      State.p.points += 3;
      State.p.maxHp += 10;
      leveled = true;
    }

    if(leveled) {
      State.p.hp = State.p.maxHp; // Cura total ao upar
      UI.log(`Level UP!`, 'crit');
      UI.fxFloat('UP!','crit');
    }
    // -------------------------------------

    State.combat = null;
    UI.setScreen(e.e);
    setTimeout(() => {
      Core.travel(State.loc);
    }, 1200);
  },

  claimQuest: (qid) => {
    const q = DB.quests.find(x => x.id === qid);
    if(q) {
      State.q[q.target] = 'done';
      State.p.gold += q.reward_g;
      State.p.xp += q.reward_xp;
      State.tempReward = { g:q.reward_g, x:q.reward_xp };
      UI.openModal('reward');
      Core.save();
    }
  },

  useItem: (k) => {
    if(State.p.inv[k]>0) {
      State.p.inv[k]--;
      const it = DB.items[k];
      if(it.dmg) {
        if(!State.combat) return;
        State.combat.e.hp -= it.dmg;
        UI.log(`Bomba: ${it.dmg}`);
        if(State.combat.e.hp<=0) Core.win();
      } else {
        it.effect(State.p);
        UI.log(`Usou ${it.name}.`);
      }
      UI.closeModal(); Core.save();
    }
  },

  openShop: () => {
    const ct = document.getElementById('modal-content');
    const tt = document.getElementById('modal-title');
    document.getElementById('modal-overlay').style.display = 'flex';
    tt.innerText = 'Loja';
    ct.innerHTML = `
      <div class="tab-menu">
        <div class="tab-btn active" onclick="Core.renderShopTab('items')">Itens</div>
        <div class="tab-btn" onclick="Core.renderShopTab('gear')">Gear</div>
        <div class="tab-btn" onclick="Core.renderShopTab('mounts')">Mount</div>
      </div>
      <div id="shop-body"></div>
    `;
    Core.renderShopTab('items');
  },

  renderShopTab: (tab) => {
    document.querySelectorAll('.tab-btn').forEach(b => {
      b.classList.toggle('active', b.innerText.toLowerCase().includes(tab==='gear'?'gear':(tab==='mount'?'mount':'item')));
    });

    const body = document.getElementById('shop-body');
    body.innerHTML = '';
    const p = State.p;
    
    if(tab === 'items') {
      for(let k in DB.items) {
        const it = DB.items[k];
        if(!it.dmg || k==='bomb') body.innerHTML += `<div class="card-item" onclick="Core.buy('item','${k}')"><span>${it.e} ${it.name} <small>${it.desc}</small></span> <b>${it.val}ü™ô</b></div>`;
      }
    }
    else if(tab === 'gear') {
      const c = p.class;
      const listW = DB.gear.weapons[c];
      const listA = DB.gear.armors[c];
      
      const nw = listW[p.wpn+1];
      if(nw) body.innerHTML += `<div class="card-item" onclick="Core.buy('wpn')"><span>‚öîÔ∏è ${nw.n} (${nw.v}-${nw.x})</span> <b>${nw.c}ü™ô</b></div>`;
      else body.innerHTML += `<div class="card-item"><span>‚öîÔ∏è Max!</span></div>`;
      
      const na = listA[p.arm+1];
      if(na) body.innerHTML += `<div class="card-item" onclick="Core.buy('arm')"><span>üõ°Ô∏è ${na.n} (+${na.v})</span> <b>${na.c}ü™ô</b></div>`;
      else body.innerHTML += `<div class="card-item"><span>üõ°Ô∏è Max!</span></div>`;
    }
    else if(tab === 'mounts') {
      for(let k in DB.mounts) {
        const m = DB.mounts[k];
        const owned = p.mount === k;
        body.innerHTML += `<div class="card-item" style="${owned?'border:1px solid var(--gold)':''}" onclick="Core.buy('mount','${k}')">
          <div class="row"><span style="font-size:24px">${m.e}</span> <div><b>${m.name}</b><br><small>${m.desc}</small></div></div>
          ${owned ? '<b>‚úÖ</b>' : `<b>${m.cost}ü™ô</b>`}
        </div>`;
      }
    }
  },

  buy: (type, k) => {
    const p = State.p;
    if(type === 'item') {
      const it = DB.items[k];
      if(p.gold >= it.val) { p.gold-=it.val; p.inv[k]=(p.inv[k]||0)+1; UI.log('Comprou.'); }
    } 
    else if(type === 'mount') {
      const m = DB.mounts[k];
      if(p.mount === k) { UI.log('J√° tem.'); return; }
      if(p.gold >= m.cost) { p.gold-=m.cost; p.mount=k; UI.log(`Comprou ${m.name}!`); Core.renderShopTab('mounts'); }
    }
    else {
      const c = p.class;
      const list = type==='wpn' ? DB.gear.weapons[c] : DB.gear.armors[c];
      const idx = type==='wpn' ? p.wpn : p.arm;
      const it = list[idx+1];
      
      if(it && p.gold >= it.c) {
        p.gold -= it.c;
        if(type==='wpn') p.wpn++; else p.arm++;
        UI.log('Melhorou!');
        Core.renderShopTab('gear');
      } else {
        UI.log('Sem ouro.');
      }
    }
    Core.save();
  }
};

Core.init();
</script>
</body>
</html>
