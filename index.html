<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RPG Emojis 5.0: Edi√ß√£o √âpica</title>

<style>
  :root{
    --bg:#0f172a; --panel:#1e293b; --text:#e2e8f0; --accent:#38bdf8;
    --btn:#334155; --btnHover:#475569; --border:#475569;
    --hp:#ef4444; --mp:#60a5fa; --xp:#22c55e; --gold:#fbbf24;
    --crit:#facc15; --miss:#94a3b8; --dmg:#f87171;
  }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); color:var(--text); font:14px/1.5 system-ui,sans-serif; user-select:none; transition: background 0.8s ease; }
  
  /* Temas de Mapa */
  body.theme-town { background: linear-gradient(to bottom, #1e293b, #0f172a); }
  body.theme-forest { background: linear-gradient(to bottom, #14532d, #052e16); }
  body.theme-cave { background: linear-gradient(to bottom, #3f2e3e, #1a1a1a); }
  body.theme-graveyard { background: linear-gradient(to bottom, #312e81, #1e1b4b); }
  body.theme-volcano { background: linear-gradient(to bottom, #7f1d1d, #450a0a); }
  body.theme-void { background: linear-gradient(to bottom, #000000, #2d0036); }

  #app{ max-width: 1000px; margin: 20px auto; padding: 10px; display:grid; gap:12px; position:relative; }
  
  /* Utilit√°rios */
  .hidden { display:none !important; }
  .row { display:flex; align-items:center; gap:8px; }
  .between { justify-content:space-between; }
  .btn { background:var(--btn); color:inherit; border:1px solid var(--border); padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700; transition:0.2s; display:flex; align-items:center; justify-content:center; gap:6px; box-shadow:0 2px 0 rgba(0,0,0,0.3); }
  .btn:hover:not(:disabled) { filter:brightness(1.2); transform:translateY(-2px); }
  .btn:active:not(:disabled) { transform:translateY(0); }
  .btn:disabled { opacity:0.5; cursor:not-allowed; filter:grayscale(1); }
  .btn-big { width:100%; padding:16px; font-size:16px; margin-top:6px; }
  
  /* Layout */
  .header { display:flex; justify-content:space-between; align-items:center; padding:0 4px; margin-bottom:10px; }
  .grid-layout { display:grid; grid-template-columns: 280px 1fr 280px; gap:16px; }
  @media (max-width: 900px){ .grid-layout{grid-template-columns: 1fr} }
  
  .panel { background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 10px 20px rgba(0,0,0,0.4); }
  .title { font-weight:800; border-bottom:2px solid var(--border); margin-bottom:12px; padding-bottom:6px; letter-spacing:0.5px; color:var(--accent); display:flex; justify-content:space-between; }

  /* Barras */
  .bar-box { background:rgba(0,0,0,0.6); height:16px; border-radius:8px; overflow:hidden; width:100%; margin-top:4px; border:1px solid rgba(255,255,255,0.1); position:relative; }
  .bar-fill { height:100%; width:0%; transition:width 0.4s ease-out; }
  .c-hp { background:linear-gradient(90deg, #991b1b, #ef4444); } 
  .c-mp { background:linear-gradient(90deg, #1e40af, #60a5fa); } 
  .c-xp { background:linear-gradient(90deg, #166534, #22c55e); }

  /* Tela de Jogo */
  .screen { height:260px; background:rgba(0,0,0,0.4); border-radius:12px; border:1px solid var(--border); display:flex; align-items:center; justify-content:center; flex-direction:column; position:relative; overflow:hidden; backdrop-filter:blur(2px); }
  .main-emoji { font-size:100px; z-index:2; filter:drop-shadow(0 10px 30px rgba(0,0,0,0.7)); transition:transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  .bg-emoji { position:absolute; font-size:240px; opacity:0.06; z-index:1; animation: pulseBg 8s infinite alternate; }
  @keyframes pulseBg { from{transform:scale(1) rotate(-5deg)} to{transform:scale(1.1) rotate(5deg)} }

  /* Anima√ß√£o do Dado (Overlay) */
  #dice-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.85); z-index:20; display:none; flex-direction:column; align-items:center; justify-content:center; border-radius:12px; backdrop-filter:blur(5px); }
  .dice-box { font-size:80px; display:flex; align-items:center; gap:20px; }
  .dice-anim { animation: rollShake 0.1s infinite; display:inline-block; }
  .dice-res { color:var(--accent); font-weight:bold; font-size:100px; text-shadow:0 0 20px var(--accent); animation: popIn 0.3s; }
  @keyframes rollShake { 0%{transform:rotate(0deg)} 25%{transform:rotate(10deg)} 75%{transform:rotate(-10deg)} }
  @keyframes popIn { 0%{transform:scale(0)} 70%{transform:scale(1.2)} 100%{transform:scale(1)} }

  /* Efeitos de Dano */
  .dmg-pop { position:absolute; font-weight:900; font-size:36px; animation: floatUp 1s forwards; z-index:15; text-shadow:0 4px 8px rgba(0,0,0,1); pointer-events:none; }
  @keyframes floatUp { 0%{transform:translateY(0) scale(0.5);opacity:0} 10%{opacity:1;transform:translateY(-20px) scale(1.2)} 100%{transform:translateY(-100px) scale(1);opacity:0} }

  /* Logs e Listas */
  .log-area { height:180px; overflow-y:auto; background:rgba(0,0,0,0.5); padding:10px; border-radius:8px; font-family:'Courier New', monospace; margin-top:12px; font-size:13px; border:1px solid var(--border); box-shadow:inset 0 0 10px rgba(0,0,0,0.5); }
  .log-line { margin-bottom:6px; border-bottom:1px dashed rgba(255,255,255,0.05); padding-bottom:4px; }
  
  /* Quests */
  .quest-box { max-height:200px; overflow-y:auto; }
  .quest-card { background:rgba(255,255,255,0.03); border-left:4px solid #555; padding:8px; margin-bottom:6px; font-size:13px; }
  .quest-card.active { border-color:var(--gold); background:rgba(251, 191, 36, 0.05); }
  .quest-card.done { border-color:var(--xp); opacity:0.5; text-decoration:line-through; }

  /* Modais */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.92); backdrop-filter:blur(8px); display:none; align-items:center; justify-content:center; z-index:100; }
  .modal-box { background:var(--panel); padding:24px; border-radius:16px; width:100%; max-width:500px; border:1px solid var(--border); max-height:85vh; overflow-y:auto; }
  .card-item { background:rgba(255,255,255,0.05); padding:14px; border-radius:10px; cursor:pointer; border:1px solid transparent; margin-bottom:8px; transition:0.2s; display:flex; justify-content:space-between; align-items:center; }
  .card-item:hover { border-color:var(--accent); background:rgba(255,255,255,0.1); transform:translateX(5px); }
</style>
</head>
<body>

<div id="app">
  <div class="header">
    <div class="row"><span style="font-size:32px">üêâ</span> <div style="line-height:1.1"><b>RPG Emojis</b><br><small style="color:var(--gold); letter-spacing:1px; font-size:11px">EDI√á√ÉO √âPICA 5.0</small></div></div>
    <div class="row">
      <button class="btn" onclick="UI.openModal('inv')">üéí Inv</button>
      <button class="btn" onclick="UI.openModal('map')">üó∫Ô∏è Mapa</button>
      <button class="btn" style="border-color:var(--hp); color:var(--hp)" onclick="Core.resetGame()">‚úï Reset</button>
    </div>
  </div>

  <div class="grid-layout">
    <div class="panel">
      <div class="title">
        <span>Ficha</span> 
        <span id="ui-class" style="color:var(--accent); text-transform:uppercase; font-size:11px; border:1px solid var(--accent); padding:2px 6px; border-radius:4px"></span>
      </div>
      <div class="row between" style="margin-bottom:12px; background:rgba(0,0,0,0.3); padding:8px; border-radius:8px">
        <span class="row">‚≠ê Lvl <b id="ui-lvl">1</b></span>
        <span class="row" style="color:var(--gold)">ü™ô <b id="ui-gold">0</b></span>
      </div>
      
      <div style="display:flex; flex-direction:column; gap:8px">
        <div>
          <div class="row between"><small>HP</small> <small id="ui-hp-txt">0/0</small></div>
          <div class="bar-box"><div id="bar-hp" class="bar-fill c-hp"></div></div>
        </div>
        <div>
          <div class="row between"><small>MP</small> <small id="ui-mp-txt">0/0</small></div>
          <div class="bar-box"><div id="bar-mp" class="bar-fill c-mp"></div></div>
        </div>
        <div>
          <div class="row between"><small>XP</small> <small id="ui-xp-txt">0/0</small></div>
          <div class="bar-box"><div id="bar-xp" class="bar-fill c-xp"></div></div>
        </div>
      </div>

      <div class="title" style="margin-top:24px">Equipamento</div>
      <div class="row between card-item" style="padding:8px; cursor:default; hover:none">
        <span class="row">üó°Ô∏è <span id="ui-wpn-name" style="font-size:13px">...</span></span>
        <b id="ui-wpn-dmg" style="font-size:12px; color:#aaa">0-0</b>
      </div>
      <div class="row between card-item" style="padding:8px; cursor:default">
        <span class="row">üõ°Ô∏è <span id="ui-arm-name" style="font-size:13px">...</span></span>
        <b id="ui-arm-def" style="font-size:12px; color:#aaa">+0</b>
      </div>
    </div>

    <div class="panel" style="position:relative">
      <div id="game-screen" class="screen">
        <div id="ui-bg-emoji" class="bg-emoji"></div>
        <div id="ui-main-emoji" class="main-emoji">ü§î</div>
        
        <div id="dice-overlay">
          <div style="font-size:20px; color:#aaa; margin-bottom:10px">Rolando D20...</div>
          <div class="dice-box">
            <div id="dice-icon" class="dice-anim">üé≤</div>
            <div id="dice-result" style="width:120px; text-align:center">...</div>
          </div>
        </div>

        <div id="turn-indicator" class="hidden" style="position:absolute; top:12px; background:rgba(0,0,0,0.8); padding:6px 16px; border-radius:20px; font-size:12px; font-weight:bold; color:#fff; border:1px solid #555"></div>
      </div>
      
      <div id="ui-actions" class="grid-layout" style="grid-template-columns:1fr 1fr; margin-top:16px; gap:10px"></div>
      <div id="ui-log" class="log-area"></div>
    </div>

    <div class="panel">
      <div class="title">Local</div>
      <div style="text-align:center; padding:15px; background:rgba(0,0,0,0.3); border-radius:8px; border:1px dashed var(--border)">
        <div id="ui-loc-emoji" style="font-size:48px; margin-bottom:5px"></div>
        <div id="ui-loc-name" style="font-weight:900; font-size:20px"></div>
        <div id="ui-loc-desc" style="font-size:12px; opacity:0.7; margin-top:4px"></div>
      </div>
      <div class="title" style="margin-top:24px">Miss√µes</div>
      <div id="ui-quests" class="quest-box"></div>
    </div>
  </div>
</div>

<div id="modal-overlay" class="modal-overlay">
  <div class="modal-box">
    <div class="row between title">
      <span id="modal-title">T√≠tulo</span>
      <button class="btn" onclick="UI.closeModal()">‚úï</button>
    </div>
    <div id="modal-content"></div>
  </div>
</div>

<script>
const DB = {
  // 1. Classes Balanceadas
  classes: {
    warrior: { name:'Guerreiro', e:'‚öîÔ∏è', hp:180, mp:30, agi:2, crit:20, desc:'Resistente e forte.' },
    rogue:   { name:'Ladino',    e:'üó°Ô∏è', hp:120, mp:50, agi:8, crit:18, desc:'Muito r√°pido. Cr√≠tico 18+.' },
    mage:    { name:'Mago',      e:'üîÆ', hp:90,  mp:120,agi:4, crit:20, desc:'Mestre das magias.' },
    paladin: { name:'Paladino',  e:'üõ°Ô∏è', hp:160, mp:60, agi:1, crit:20, desc:'Defensivo e cura.' }
  },
  
  // 2. Mapas (Progress√£o Lenta)
  maps: {
    town:      { name:'Vila',       e:'üèòÔ∏è', lvl:1,  theme:'town', type:'safe', desc:'Paz, descanso e compras.' },
    forest:    { name:'Floresta',   e:'üå≤', lvl:1,  theme:'forest', type:'combat', mobs:['rat','wolf','thief'], desc:'N√≠vel 1-4' },
    cave:      { name:'Caverna',    e:'üï∏Ô∏è', lvl:5,  theme:'cave', type:'combat', mobs:['bat','spider','orc'], desc:'N√≠vel 5-9' },
    graveyard: { name:'Cemit√©rio',  e:'‚ö∞Ô∏è', lvl:10, theme:'graveyard', type:'combat', mobs:['skel','zombie','ghost'], desc:'N√≠vel 10-14' },
    volcano:   { name:'Vulc√£o',     e:'üåã', lvl:15, theme:'volcano', type:'combat', mobs:['imp','golem','dragon'], desc:'N√≠vel 15-19' },
    void:      { name:'O Vazio',    e:'üåå', lvl:20, theme:'void', type:'combat', mobs:['shadow','voidking'], desc:'N√≠vel 20+ (Final)' }
  },

  // 3. Monstros (Stats aumentados)
  mobs: {
    rat:    { name:'Rato',      e:'üêÄ', hp:30,  agi:1, atk:5,  xp:10,  gold:4 },
    wolf:   { name:'Lobo',      e:'üê∫', hp:50,  agi:5, atk:8,  xp:20,  gold:8 },
    thief:  { name:'Bandido',   e:'ü•∑', hp:60,  agi:6, atk:10, xp:30,  gold:15 },
    
    bat:    { name:'Morcego',   e:'ü¶á', hp:50,  agi:9, atk:8,  xp:35,  gold:10 },
    spider: { name:'Aranha',    e:'üï∑Ô∏è', hp:80,  agi:7, atk:12, xp:50,  gold:20 },
    orc:    { name:'Orc',       e:'üëπ', hp:120, agi:3, atk:15, xp:70,  gold:30 },

    skel:   { name:'Esqueleto', e:'üíÄ', hp:100, agi:4, atk:18, xp:90,  gold:35 },
    zombie: { name:'Zumbi',     e:'üßü', hp:150, agi:1, atk:22, xp:110, gold:40 },
    ghost:  { name:'Fantasma',  e:'üëª', hp:110, agi:10,atk:25, xp:130, gold:50 },

    imp:    { name:'Diabrete',  e:'üëø', hp:140, agi:12,atk:28, xp:160, gold:60 },
    golem:  { name:'Golem',     e:'üóø', hp:300, agi:0, atk:40, xp:250, gold:100 },
    dragon: { name:'Drag√£o',    e:'üêâ', hp:400, agi:6, atk:50, xp:500, gold:300, boss:true },

    shadow: { name:'Sombra',    e:'üë§', hp:350, agi:15,atk:60, xp:600, gold:200 },
    voidking:{name:'Rei Vazio', e:'üëë', hp:1000,agi:8, atk:90, xp:5000,gold:5000, boss:true }
  },

  // 4. Miss√µes (Mais longas)
  quests: [
    { id:'q1', target:'rat', count:5, title:'Praga de Ratos', reward_g:50, reward_xp:50 },
    { id:'q2', target:'wolf', count:10, title:'Peles de Lobo', reward_g:150, reward_xp:200 },
    { id:'q3', target:'orc', count:8, title:'Limpar Caverna', reward_g:300, reward_xp:400 },
    { id:'q4', target:'skel', count:15, title:'Ex√©rcito de Ossos', reward_g:600, reward_xp:800 },
    { id:'q5', target:'ghost', count:10, title:'Exorcismo', reward_g:800, reward_xp:1000 },
    { id:'q6', target:'golem', count:5, title:'Pedras de Magma', reward_g:1500, reward_xp:2000 },
    { id:'q7', target:'dragon', count:1, title:'O Drag√£o', reward_g:3000, reward_xp:5000 },
    { id:'q8', target:'voidking', count:1, title:'SALVAR O MUNDO', reward_g:10000, reward_xp:10000 }
  ],

  // 5. Itens (Caros)
  items: {
    pot:  { name:'Po√ß√£o Vida', e:'üß™', val:25, effect:p=>p.hp=Math.min(p.maxHp, p.hp+60), desc:'+60 HP' },
    ether:{ name:'√âter Mana',  e:'üî∑', val:25, effect:p=>p.mp=Math.min(p.maxMp, p.mp+40), desc:'+40 MP' },
    bomb: { name:'Bomba',      e:'üí£', val:50, dmg:50, desc:'50 Dano Fixo' }
  },
  weapons: [
    { name:'Punhos', min:1, max:3 }, 
    { name:'Adaga', min:4, max:8, cost:100 }, 
    { name:'Espada Curta', min:8, max:14, cost:350 }, 
    { name:'Machado Guerra', min:12, max:24, cost:900 },
    { name:'L√¢mina Mitril', min:20, max:35, cost:2500 },
    { name:'Excalibur', min:40, max:60, cost:8000 }
  ],
  armors: [
    { name:'Roupa', def:0 }, 
    { name:'Couro', def:3, cost:100 }, 
    { name:'Malha', def:7, cost:350 }, 
    { name:'Placas', def:14, cost:900 },
    { name:'Drac√¥nica', def:22, cost:2500 },
    { name:'Divina', def:35, cost:8000 }
  ],
  skills: {
    bash: { name:'Golpe', cost:5, bonus:5, dice:8 },
    stab: { name:'Furar', cost:5, bonus:3, dice:10 },
    fire: { name:'Fogo',  cost:10, bonus:8, dice:20 },
    heal: { name:'Cura',  cost:12, val:50, type:'heal' }
  }
};

// =======================================================================
// CORE & UI
// =======================================================================
let State = {
  p: { name:'Her√≥i', class:null, lvl:1, xp:0, gold:0, hp:100, mp:50, maxHp:100, maxMp:50, wpn:0, arm:0, inv:{} },
  loc: 'town',
  combat: null,
  q: {}
};

const Dice = {
  d20: () => Math.floor(Math.random()*20)+1,
  roll: (min, max) => Math.floor(Math.random()*(max-min+1))+min
};

const UI = {
  render: () => {
    const p = State.p;
    const c = DB.classes[p.class];
    
    // Header
    document.getElementById('ui-lvl').innerText = p.lvl;
    document.getElementById('ui-gold').innerText = p.gold;
    document.getElementById('ui-class').innerText = c ? c.name : '';
    
    // Bars
    const setBar = (id, cur, max) => {
      document.getElementById(`ui-${id}-txt`).innerText = `${Math.floor(cur)}/${max}`;
      document.getElementById(`bar-${id}`).style.width = Math.min(100, (cur/max)*100) + '%';
    };
    setBar('hp', p.hp, p.maxHp);
    setBar('mp', p.mp, p.maxMp);
    setBar('xp', p.xp, p.lvl*150); // Leveling mais lento

    // Gear
    const w = DB.weapons[p.wpn];
    const a = DB.armors[p.arm];
    document.getElementById('ui-wpn-name').innerText = w.name;
    document.getElementById('ui-wpn-dmg').innerText = `${w.min}-${w.max} dmg`;
    document.getElementById('ui-arm-name').innerText = a.name;
    document.getElementById('ui-arm-def').innerText = `+${a.def} def`;

    // Quests
    const qBox = document.getElementById('ui-quests');
    qBox.innerHTML = '';
    DB.quests.forEach(q => {
      const cur = State.q[q.target] || 0;
      const done = cur >= q.count;
      qBox.innerHTML += `
        <div class="quest-card ${done?'done':(cur>0?'active':'')} row between">
          <span>${done?'‚úÖ':'‚¨ú'} <b>${q.title}</b> <small>(${DB.mobs[q.target].e})</small></span>
          <small>${Math.min(cur,q.count)}/${q.count}</small>
        </div>`;
    });
  },

  log: (msg, type='') => {
    const box = document.getElementById('ui-log');
    const div = document.createElement('div');
    div.className = `log-line ${type}`;
    div.innerHTML = msg;
    box.prepend(div);
  },

  // Anima√ß√£o de Dados √âpica
  rollDiceAnim: (finalValue, callback) => {
    const overlay = document.getElementById('dice-overlay');
    const resDiv = document.getElementById('dice-result');
    const icon = document.getElementById('dice-icon');
    
    overlay.style.display = 'flex';
    resDiv.classList.remove('dice-res');
    icon.classList.add('dice-anim');
    
    let rolls = 0;
    const interval = setInterval(() => {
      resDiv.innerText = Math.floor(Math.random()*20)+1;
      rolls++;
      if(rolls > 10) {
        clearInterval(interval);
        resDiv.innerText = finalValue;
        resDiv.classList.add('dice-res');
        icon.classList.remove('dice-anim');
        
        // Cor do resultado
        if(finalValue === 20) resDiv.style.color = 'var(--crit)';
        else if(finalValue === 1) resDiv.style.color = 'var(--hp)';
        else resDiv.style.color = 'var(--accent)';

        setTimeout(() => {
          overlay.style.display = 'none';
          callback();
        }, 800);
      }
    }, 80);
  },

  fxFloat: (txt, type) => {
    const el = document.createElement('div');
    el.className = 'dmg-pop'; el.innerHTML = txt;
    el.style.color = type==='crit'?'var(--crit)':(type==='miss'?'#888':(type==='bad'?'var(--hp)':'#fff'));
    el.style.left = (30 + Math.random()*40) + '%';
    el.style.top = (30 + Math.random()*20) + '%';
    document.getElementById('game-screen').appendChild(el);
    setTimeout(()=>el.remove(), 1000);
  },

  setScreen: (emoji, bg) => {
    document.getElementById('ui-main-emoji').innerText = emoji;
    if(bg) document.getElementById('ui-bg-emoji').innerText = bg;
  },
  
  openModal: (type) => {
    const ct = document.getElementById('modal-content');
    const tt = document.getElementById('modal-title');
    document.getElementById('modal-overlay').style.display = 'flex';
    ct.innerHTML = '';
    
    if(type === 'class') {
      tt.innerText = 'Escolha sua Classe';
      for(let k in DB.classes) {
        const c = DB.classes[k];
        ct.innerHTML += `<div class="card-item" onclick="Core.setClass('${k}')">
          <div class="row"><span style="font-size:32px">${c.e}</span> <div><b>${c.name}</b><br><small>${c.desc}</small></div></div>
        </div>`;
      }
    } 
    else if(type === 'map') {
      tt.innerText = 'Mundo';
      for(let k in DB.maps) {
        const m = DB.maps[k];
        const locked = State.p.lvl < m.lvl;
        ct.innerHTML += `<div class="card-item" style="opacity:${locked?0.5:1}" onclick="${locked?'':'Core.travel(\''+k+'\')'}">
          <div class="row"><span style="font-size:24px">${m.e}</span> <div><b>${m.name}</b><br><small>${m.desc}</small></div></div>
          ${locked ? '<small>üîí Nvl '+m.lvl+'</small>' : '<b>IR ‚ûî</b>'}
        </div>`;
      }
    }
    else if(type === 'inv') {
      tt.innerText = 'Invent√°rio';
      for(let k in State.p.inv) {
        if(State.p.inv[k]>0) {
          const it = DB.items[k];
          ct.innerHTML += `<div class="card-item" onclick="Core.useItem('${k}')">
            <span>${it.e} ${it.name} (x${State.p.inv[k]})</span> <b>USAR</b>
          </div>`;
        }
      }
      if(!ct.innerHTML) ct.innerHTML = '<div style="text-align:center;color:#666">Vazio.</div>';
    }
  },
  closeModal: () => document.getElementById('modal-overlay').style.display = 'none'
};

const Core = {
  init: () => {
    const s = localStorage.getItem('rpg_v5_epic');
    if(s) { State = JSON.parse(s); Core.travel(State.loc); UI.log('Jogo carregado.'); } 
    else { UI.openModal('class'); }
    UI.render();
  },
  save: () => { localStorage.setItem('rpg_v5_epic', JSON.stringify(State)); UI.render(); },
  resetGame: () => { if(confirm('Apagar tudo?')){ localStorage.removeItem('rpg_v5_epic'); location.reload(); } },

  setClass: (k) => {
    const c = DB.classes[k];
    State.p.class = k;
    State.p.maxHp = c.hp; State.p.hp = c.hp;
    State.p.maxMp = c.mp; State.p.mp = c.mp;
    State.p.inv = { pot:3 };
    UI.closeModal(); Core.travel('town');
  },

  travel: (id) => {
    State.loc = id; State.combat = null;
    UI.closeModal();
    const map = DB.maps[id];
    UI.setScreen(map.e, map.e);
    document.body.className = `theme-${map.theme}`;
    document.getElementById('ui-loc-emoji').innerText = map.e;
    document.getElementById('ui-loc-name').innerText = map.name;
    document.getElementById('ui-loc-desc').innerText = map.desc;
    document.getElementById('turn-indicator').classList.add('hidden');

    const area = document.getElementById('ui-actions');
    area.innerHTML = '';
    
    if(map.type === 'safe') {
      area.innerHTML = `
        <button class="btn btn-big" onclick="Core.rest()">üõå Descansar</button>
        <button class="btn btn-big" onclick="Core.openShop()">üí∞ Mercador</button>
        <button class="btn btn-big" style="border-color:var(--xp)" onclick="UI.openModal('map')">üó∫Ô∏è Viajar</button>
      `;
    } else {
      area.innerHTML = `
        <button class="btn btn-big" onclick="Core.explore()">üé≤ Explorar</button>
        <button class="btn btn-big" onclick="Core.travel('town')">üèÉ Fugir</button>
      `;
    }
    Core.save();
  },

  rest: () => {
    State.p.hp = State.p.maxHp; State.p.mp = State.p.maxMp;
    UI.log('Voc√™ dormiu na estalagem.', 'color:#aaa');
    UI.fxFloat('üí§','miss'); Core.save();
  },

  explore: () => {
    const map = DB.maps[State.loc];
    if(Math.random() < 0.25) { // 25% chance de loot
      const g = Dice.roll(10, 30) * map.lvl;
      State.p.gold += g;
      UI.log(`Encontrou um ba√∫ com ${g} ouro!`);
      UI.fxFloat(`+${g}ü™ô`, 'crit');
      Core.save();
    } else {
      const mobs = map.mobs;
      const key = mobs[Math.floor(Math.random()*mobs.length)];
      Core.startCombat(key);
    }
  },

  // --- COMBATE ---
  startCombat: (key) => {
    const m = DB.mobs[key];
    State.combat = { e: { ...m, maxHp:m.hp }, turn: 0 };
    UI.setScreen(m.e, '‚öîÔ∏è');
    UI.log(`‚öîÔ∏è <b>${m.name}</b> apareceu!`, 'color:var(--dmg)');
    
    // Iniciativa
    const pAgi = DB.classes[State.p.class].agi;
    const pInit = Dice.d20() + pAgi;
    const eInit = Dice.d20() + m.agi;
    
    if(eInit > pInit) {
      UI.log(`${m.name} √© mais r√°pido!`);
      document.getElementById('turn-indicator').innerText = "TURNO DO INIMIGO";
      document.getElementById('turn-indicator').classList.remove('hidden');
      document.getElementById('turn-indicator').style.background = "var(--hp)";
      Core.renderBtns(true);
      setTimeout(() => Core.enemyTurn(true), 1200);
    } else {
      UI.log(`Voc√™ age primeiro!`);
      document.getElementById('turn-indicator').innerText = "SEU TURNO";
      document.getElementById('turn-indicator').classList.remove('hidden');
      document.getElementById('turn-indicator').style.background = "var(--accent)";
      Core.renderBtns(false);
    }
  },

  renderBtns: (disabled) => {
    const area = document.getElementById('ui-actions');
    // Pega skill da classe
    let sk = 'bash';
    if(State.p.class === 'rogue') sk = 'stab';
    if(State.p.class === 'mage') sk = 'fire';
    if(State.p.class === 'paladin') sk = 'heal';
    const sData = DB.skills[sk];

    area.innerHTML = `
      <button class="btn btn-big" ${disabled?'disabled':''} onclick="Core.act('atk')">‚öîÔ∏è Atacar</button>
      <button class="btn btn-big" ${disabled?'disabled':''} onclick="Core.act('skill','${sk}')" style="color:var(--mp)">‚ú® ${sData.name} (${sData.cost})</button>
      <button class="btn btn-big" ${disabled?'disabled':''} onclick="UI.openModal('inv')">üéí Item</button>
      <button class="btn btn-big" ${disabled?'disabled':''} onclick="Core.travel('town')">üèÉ Fugir</button>
    `;
  },

  act: (type, skKey) => {
    if(!State.combat) return;
    const p = State.p;
    
    // Verifica Mana antes
    if(type === 'skill') {
      if(p.mp < DB.skills[skKey].cost) { UI.log('Sem mana!'); return; }
      p.mp -= DB.skills[skKey].cost;
    }

    // Rola o dado visualmente, depois executa
    const d20 = Dice.d20();
    UI.rollDiceAnim(d20, () => {
      Core.resolvePlayer(d20, type, skKey);
    });
  },

  resolvePlayer: (roll, type, skKey) => {
    const p = State.p;
    const e = State.combat.e;
    const c = DB.classes[p.class];
    const w = DB.weapons[p.wpn];
    let dmg = 0;

    if(roll === 1) {
      UI.log('üé≤ 1: Falha Cr√≠tica! Voc√™ escorregou.', 'color:var(--miss)');
      UI.fxFloat('FALHA','miss');
      p.hp -= Math.floor(p.maxHp * 0.05); // 5% dano
    } else {
      let isCrit = roll >= c.crit;
      if(type === 'atk') {
        let base = Dice.roll(w.min, w.max) + Math.floor(p.lvl/2);
        if(isCrit) { base = Math.floor(base * 1.8); UI.fxFloat('CRIT!','crit'); }
        else UI.fxFloat(base,'#fff');
        dmg = base;
        e.hp -= dmg;
        UI.log(`üé≤ ${roll}: Atacou por <b>${dmg}</b> dano.`);
      } 
      else if(type === 'skill') {
        const s = DB.skills[skKey];
        if(s.type === 'heal') {
          p.hp = Math.min(p.maxHp, p.hp + s.val);
          UI.log(`üé≤ ${roll}: Curou ${s.val} HP.`);
          UI.fxFloat('‚ù§','crit');
        } else {
          let base = Dice.roll(1, s.dice) + s.bonus + p.lvl;
          if(roll===20) { base *= 2; UI.fxFloat('MAX!','crit'); }
          e.hp -= base;
          UI.log(`‚ú® ${s.name}: <b>${base}</b> dano.`);
          UI.fxFloat(base,'var(--mp)');
        }
      }
    }

    if(e.hp <= 0) Core.win();
    else {
      Core.renderBtns(true);
      setTimeout(() => Core.enemyTurn(), 1000);
    }
    Core.save();
  },

  enemyTurn: (skipMsg) => {
    if(!State.combat) return;
    const p = State.p;
    const e = State.combat.e;
    const armor = DB.armors[p.arm].def;
    
    const roll = Dice.d20();
    if(roll === 1) {
      UI.log(`${e.name} errou o ataque!`);
    } else {
      let dmg = Math.max(0, (e.atk + Dice.roll(-2, 2)) - armor);
      if(roll === 20) { dmg *= 2; UI.log(`${e.name} CRITOU!`); }
      p.hp -= dmg;
      if(dmg > 0) {
        if(!skipMsg) UI.log(`${e.name} causou ${dmg} dano.`);
        UI.fxFloat(`-${dmg}`,'bad');
        document.getElementById('game-screen').style.animation = 'shake 0.3s';
        setTimeout(()=>document.getElementById('game-screen').style.animation='',300);
      } else {
        UI.log(`Sua armadura tankou o hit.`);
        UI.fxFloat('BLOK','miss');
      }
    }

    if(p.hp <= 0) {
      UI.log('üíÄ VOC√ä MORREU...', 'color:red');
      p.hp = 1; p.gold = Math.floor(p.gold/2);
      Core.travel('town');
    } else {
      Core.renderBtns(false);
      document.getElementById('turn-indicator').innerText = "SEU TURNO";
      document.getElementById('turn-indicator').style.background = "var(--accent)";
    }
    Core.save();
  },

  win: () => {
    const e = State.combat.e;
    UI.log(`üèÜ Vit√≥ria! +${e.xp}XP +${e.gold} Ouro`);
    State.p.gold += e.gold;
    State.p.xp += e.xp;
    
    // Quest
    // Acha a key pelo nome (metodo simples)
    let key = Object.keys(DB.mobs).find(k => DB.mobs[k].name === e.name);
    if(key) State.q[key] = (State.q[key]||0) + 1;
    
    // Check Quest Done
    const quest = DB.quests.find(q => q.target === key);
    if(quest && State.q[key] === quest.count) {
      UI.log(`üìú MISS√ÉO CUMPRIDA: ${quest.title}!`, 'color:var(--gold)');
      State.p.gold += quest.reward_g;
      State.p.xp += quest.reward_xp;
    }

    // Level
    if(State.p.xp >= State.p.lvl * 150) {
      State.p.xp = 0; State.p.lvl++;
      State.p.maxHp += 20; State.p.hp = State.p.maxHp;
      State.p.maxMp += 10; State.p.mp = State.p.maxMp;
      UI.log(`üÜô LEVEL UP! N√≠vel ${State.p.lvl}`);
    }

    State.combat = null;
    UI.setScreen(e.e);
    document.getElementById('ui-main-emoji').style.transform = 'rotate(90deg)';
    setTimeout(() => {
      document.getElementById('ui-main-emoji').style.transform = '';
      Core.travel(State.loc);
    }, 1500);
  },

  useItem: (k) => {
    if(State.p.inv[k]>0) {
      State.p.inv[k]--;
      const it = DB.items[k];
      if(it.dmg) { // Bomba
        if(!State.combat) return;
        State.combat.e.hp -= it.dmg;
        UI.log(`Bomba explodiu: ${it.dmg} dano!`);
        if(State.combat.e.hp<=0) Core.win();
      } else {
        it.effect(State.p);
        UI.log(`Usou ${it.name}.`);
      }
      UI.closeModal(); Core.save();
    }
  },

  openShop: () => {
    const ct = document.getElementById('modal-content');
    const tt = document.getElementById('modal-title');
    document.getElementById('modal-overlay').style.display = 'flex';
    tt.innerText = 'Mercador Caro';
    ct.innerHTML = '';
    
    // Potions
    for(let k in DB.items) {
      const it = DB.items[k];
      if(!it.dmg) ct.innerHTML += `<div class="card-item" onclick="Core.buy('item','${k}')"><span>${it.e} ${it.name}</span> <b>${it.val}ü™ô</b></div>`;
    }
    ct.innerHTML += '<hr style="border-color:#555">';
    // Gear
    const nw = DB.weapons[State.p.wpn+1];
    if(nw) ct.innerHTML += `<div class="card-item" onclick="Core.buy('wpn')"><span>‚öîÔ∏è ${nw.name} (${nw.min}-${nw.max})</span> <b>${nw.cost}ü™ô</b></div>`;
    const na = DB.armors[State.p.arm+1];
    if(na) ct.innerHTML += `<div class="card-item" onclick="Core.buy('arm')"><span>üõ°Ô∏è ${na.name} (+${na.def})</span> <b>${na.cost}ü™ô</b></div>`;
  },

  buy: (type, k) => {
    const p = State.p;
    if(type === 'item') {
      const it = DB.items[k];
      if(p.gold >= it.val) { p.gold-=it.val; p.inv[k]=(p.inv[k]||0)+1; UI.log('Comprou item.'); }
    } else {
      const list = type==='wpn'?DB.weapons:DB.armors;
      const idx = type==='wpn'?p.wpn:p.arm;
      const it = list[idx+1];
      if(p.gold >= it.cost) { p.gold-=it.cost; if(type==='wpn') p.wpn++; else p.arm++; UI.log('Upgrade comprado!'); }
    }
    Core.openShop(); Core.save();
  }
};

Core.init();
</script>
</body>
</html>
