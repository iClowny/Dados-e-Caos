<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RPG Emojis 10.0: Arena Online</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
  :root{
    --bg:#0f172a; --panel:#1e293b; --text:#e2e8f0; --accent:#38bdf8;
    --btn:#334155; --btnHover:#475569; --border:#475569;
    --hp:#ef4444; --mp:#60a5fa; --xp:#22c55e; --gold:#fbbf24;
    --crit:#facc15; --miss:#94a3b8; --dmg:#f87171;
  }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); color:var(--text); font:14px/1.5 system-ui,sans-serif; user-select:none; transition: background 0.8s ease; }
  
  /* Temas */
  body.theme-town { background: linear-gradient(to bottom, #1e293b, #0f172a); }
  body.theme-forest { background: linear-gradient(to bottom, #14532d, #052e16); }
  body.theme-cave { background: linear-gradient(to bottom, #3f2e3e, #1a1a1a); }
  body.theme-graveyard { background: linear-gradient(to bottom, #312e81, #1e1b4b); }
  body.theme-volcano { background: linear-gradient(to bottom, #7f1d1d, #450a0a); }
  body.theme-void { background: linear-gradient(to bottom, #000000, #2d0036); }

  #app{ max-width: 1000px; margin: 20px auto; padding: 10px; display:grid; gap:12px; position:relative; }
  
  /* Utilit√°rios */
  .hidden { display:none !important; }
  .row { display:flex; align-items:center; gap:8px; }
  .between { justify-content:space-between; }
  .btn { background:var(--btn); color:inherit; border:1px solid var(--border); padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700; transition:0.2s; display:flex; align-items:center; justify-content:center; gap:6px; box-shadow:0 2px 0 rgba(0,0,0,0.3); }
  .btn:hover:not(:disabled) { filter:brightness(1.2); transform:translateY(-2px); }
  .btn:active:not(:disabled) { transform:translateY(0); }
  .btn:disabled { opacity:0.5; cursor:not-allowed; filter:grayscale(1); }
  .btn-big { width:100%; padding:16px; font-size:16px; margin-top:6px; }
  .btn-sm { padding:2px 8px; font-size:12px; height:24px; }
  
  /* Layout */
  .header { display:flex; justify-content:space-between; align-items:center; padding:0 4px; margin-bottom:10px; }
  .grid-layout { display:grid; grid-template-columns: 280px 1fr 280px; gap:16px; }
  @media (max-width: 900px){ .grid-layout{grid-template-columns: 1fr} }
  
  .panel { background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 10px 20px rgba(0,0,0,0.4); }
  .title { font-weight:800; border-bottom:2px solid var(--border); margin-bottom:12px; padding-bottom:6px; letter-spacing:0.5px; color:var(--accent); display:flex; justify-content:space-between; }

  /* Barras Jogador */
  .bar-box { background:rgba(0,0,0,0.6); height:16px; border-radius:8px; overflow:hidden; width:100%; margin-top:4px; border:1px solid rgba(255,255,255,0.1); position:relative; }
  .bar-fill { height:100%; width:0%; transition:width 0.4s ease-out; }
  .c-hp { background:linear-gradient(90deg, #991b1b, #ef4444); } 
  .c-mp { background:linear-gradient(90deg, #1e40af, #60a5fa); } 
  .c-xp { background:linear-gradient(90deg, #166534, #22c55e); }

  /* Stats Box */
  .stat-row { display:flex; justify-content:space-between; align-items:center; padding:4px 0; border-bottom:1px dashed rgba(255,255,255,0.1); }
  .stat-val { font-family:monospace; font-size:14px; color:#fff; }
  .stat-btn { background:var(--xp); color:#fff; border:none; width:24px; height:24px; border-radius:4px; cursor:pointer; font-weight:bold; display:flex; align-items:center; justify-content:center; }
  .mount-badge { background:rgba(255,255,255,0.1); padding:8px; border-radius:8px; font-size:13px; margin-top:10px; display:flex; align-items:center; gap:10px; border:1px solid var(--gold); }

  /* Tela de Jogo */
  .screen { height:280px; background:rgba(0,0,0,0.4); border-radius:12px; border:1px solid var(--border); display:flex; align-items:center; justify-content:center; flex-direction:column; position:relative; overflow:hidden; backdrop-filter:blur(2px); }
  .main-emoji { font-size:100px; z-index:2; filter:drop-shadow(0 10px 30px rgba(0,0,0,0.7)); transition:transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position:relative; }
  
  /* Barra Inimigo */
  .enemy-stats { width:140px; margin-top:10px; z-index:5; text-align:center; transition:opacity 0.3s; opacity:0; }
  .enemy-bar-bg { height:8px; background:#000; border-radius:4px; overflow:hidden; border:1px solid #555; }
  .enemy-bar-fill { height:100%; background:#ef4444; width:100%; transition:width 0.2s; }

  /* DUELO */
  #dice-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.85); z-index:20; display:none; flex-direction:column; align-items:center; justify-content:center; border-radius:12px; backdrop-filter:blur(5px); }
  .dice-arena { display:flex; align-items:center; gap:30px; }
  .dice-col { display:flex; flex-direction:column; align-items:center; gap:5px; }
  .dice-val { font-size:60px; font-weight:900; width:80px; height:80px; display:flex; align-items:center; justify-content:center; background:#1e293b; border-radius:12px; border:2px solid #555; }
  .d-player { color:var(--accent); border-color:var(--accent); }
  .d-enemy { color:var(--hp); border-color:var(--hp); }
  .dice-shake { animation: rollShake 0.1s infinite; }
  .winner { transform:scale(1.2); border-color:var(--gold); box-shadow:0 0 20px var(--gold); z-index:2; transition:0.3s; background:#222; }
  .loser { opacity:0.4; transform:scale(0.9); grayscale:1; }
  @keyframes rollShake { 0%{transform:rotate(0deg)} 25%{transform:rotate(5deg)} 75%{transform:rotate(-5deg)} }
  
  /* Efeitos */
  .dmg-pop { position:absolute; font-weight:900; font-size:36px; animation: floatUp 1s forwards; z-index:15; text-shadow:0 4px 8px rgba(0,0,0,1); pointer-events:none; }
  @keyframes floatUp { 0%{transform:translateY(0) scale(0.5);opacity:0} 10%{opacity:1;transform:translateY(-20px) scale(1.2)} 100%{transform:translateY(-100px) scale(1);opacity:0} }

  /* Logs e Listas */
  .log-area { height:180px; overflow-y:auto; background:rgba(0,0,0,0.5); padding:10px; border-radius:8px; font-family:'Courier New', monospace; margin-top:12px; font-size:13px; border:1px solid var(--border); box-shadow:inset 0 0 10px rgba(0,0,0,0.5); }
  .log-line { margin-bottom:6px; border-bottom:1px dashed rgba(255,255,255,0.05); padding-bottom:4px; }
  
  .quest-box { max-height:220px; overflow-y:auto; }
  .quest-card { background:rgba(255,255,255,0.03); border-left:4px solid #555; padding:10px; margin-bottom:6px; font-size:13px; display:flex; align-items:center; justify-content:space-between; }
  .quest-card.active { border-color:var(--accent); background:rgba(56, 189, 248, 0.05); }
  .quest-card.ready { border-color:var(--gold); background:rgba(251, 191, 36, 0.1); animation: pulseQ 1s infinite; }
  .quest-card.done { border-color:var(--xp); opacity:0.5; text-decoration:line-through; }
  @keyframes pulseQ { 0%{box-shadow:inset 0 0 0 transparent} 50%{box-shadow:inset 0 0 10px rgba(251, 191, 36, 0.2)} }

  /* RANKING */
  .rank-row { display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #333; font-size:14px; }
  .rank-row:nth-child(1) { color:var(--gold); font-weight:bold; font-size:16px; }
  .rank-row:nth-child(2) { color:#e2e8f0; }
  .rank-row:nth-child(3) { color:#ad7f58; }

  /* Modais */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.92); backdrop-filter:blur(8px); display:none; align-items:center; justify-content:center; z-index:100; }
  .modal-box { background:var(--panel); padding:24px; border-radius:16px; width:100%; max-width:500px; border:1px solid var(--border); max-height:85vh; overflow-y:auto; }
  .card-item { background:rgba(255,255,255,0.05); padding:14px; border-radius:10px; cursor:pointer; border:1px solid transparent; margin-bottom:8px; transition:0.2s; display:flex; justify-content:space-between; align-items:center; }
  .card-item:hover { border-color:var(--accent); background:rgba(255,255,255,0.1); transform:translateX(5px); }
  
  .tab-menu { display:flex; gap:10px; margin-bottom:10px; }
  .tab-btn { flex:1; padding:8px; background:#111; border:1px solid #444; color:#888; cursor:pointer; text-align:center; border-radius:6px; }
  .tab-btn.active { background:var(--accent); color:#000; border-color:var(--accent); font-weight:bold; }
</style>
</head>
<body>

<div id="app">
  <div class="header">
    <div class="row"><span style="font-size:32px">üèÜ</span> <div style="line-height:1.1"><b>Arena Online</b><br><small style="color:var(--gold); letter-spacing:1px; font-size:11px">RPG 10.0</small></div></div>
    <div class="row">
      <button class="btn" title="Ranking" onclick="Ranking.open()" style="border-color:var(--gold); color:var(--gold)">üëë Rank</button>
      <button class="btn" onclick="UI.openModal('inv')">üéí Inv</button>
      <button class="btn" onclick="UI.openModal('map')">üó∫Ô∏è Mapa</button>
      <button class="btn" style="border-color:var(--hp); color:var(--hp)" onclick="Core.resetGame()">‚úï</button>
    </div>
  </div>

  <div class="grid-layout">
    <div class="panel">
      <div class="title">
        <span>Her√≥i</span> 
        <span id="ui-class" style="color:var(--accent); text-transform:uppercase; font-size:11px; border:1px solid var(--accent); padding:2px 6px; border-radius:4px"></span>
      </div>
      <div class="row between" style="margin-bottom:12px; background:rgba(0,0,0,0.3); padding:8px; border-radius:8px">
        <span class="row">‚≠ê Lvl <b id="ui-lvl">1</b></span>
        <span class="row" style="color:var(--gold)">ü™ô <b id="ui-gold">0</b></span>
      </div>
      
      <div style="margin-bottom:15px">
        <div class="bar-box"><div id="bar-hp" class="bar-fill c-hp"></div></div>
        <div class="row between" style="font-size:11px; margin-top:2px; color:#aaa"><span>HP</span><span id="ui-hp-txt"></span></div>
        <div class="bar-box" style="margin-top:6px"><div id="bar-mp" class="bar-fill c-mp"></div></div>
        <div class="row between" style="font-size:11px; margin-top:2px; color:#aaa"><span>MP</span><span id="ui-mp-txt"></span></div>
        <div class="bar-box" style="margin-top:6px"><div id="bar-xp" class="bar-fill c-xp"></div></div>
        <div class="row between" style="font-size:11px; margin-top:2px; color:#aaa"><span>XP</span><span id="ui-xp-txt"></span></div>
      </div>

      <div class="title row between">
        <span>Atributos</span>
        <span id="ui-points" style="font-size:11px; background:var(--xp); padding:2px 6px; border-radius:10px; color:#fff; display:none">0 PTS</span>
      </div>
      <div class="stat-row">
        <span title="Dano F√≠sico">üí™ For√ßa</span>
        <div class="row"><b id="val-str" class="stat-val">0</b> <button class="stat-btn hidden" onclick="Core.addStat('str')">+</button></div>
      </div>
      <div class="stat-row">
        <span title="Iniciativa e Duelo">‚ö° Agilidade</span>
        <div class="row"><b id="val-agi" class="stat-val">0</b> <button class="stat-btn hidden" onclick="Core.addStat('agi')">+</button></div>
      </div>
      <div class="stat-row">
        <span title="Dano M√°gico e Mana">üß† Intelig√™ncia</span>
        <div class="row"><b id="val-int" class="stat-val">0</b> <button class="stat-btn hidden" onclick="Core.addStat('int')">+</button></div>
      </div>
      
      <div id="ui-mount" class="mount-badge hidden">
        <span id="mnt-icon" style="font-size:22px"></span> 
        <div><b id="mnt-name" style="color:var(--gold)"></b><br><small id="mnt-desc" style="color:#aaa"></small></div>
      </div>
      
      <div class="title" style="margin-top:24px">Equipamento</div>
      <div class="row between card-item" style="padding:8px; cursor:default; hover:none">
        <span class="row">üó°Ô∏è <span id="ui-wpn-name" style="font-size:13px">...</span></span>
        <b id="ui-wpn-dmg" style="font-size:12px; color:#aaa">0-0</b>
      </div>
      <div class="row between card-item" style="padding:8px; cursor:default">
        <span class="row">üõ°Ô∏è <span id="ui-arm-name" style="font-size:13px">...</span></span>
        <b id="ui-arm-def" style="font-size:12px; color:#aaa">+0</b>
      </div>

    </div>

    <div class="panel" style="position:relative">
      <div id="game-screen" class="screen">
        <div id="ui-main-emoji" class="main-emoji">ü§î</div>
        
        <div id="enemy-hud" class="enemy-stats">
          <div class="enemy-bar-bg"><div id="enemy-hp-bar" class="enemy-bar-fill"></div></div>
          <div style="font-size:10px; color:#fff; margin-top:2px">HP INIMIGO</div>
        </div>
        
        <div id="dice-overlay">
          <div style="margin-bottom:20px; font-size:18px; color:#fff; font-weight:bold" id="dice-msg">DUELO!</div>
          <div class="dice-arena">
            <div class="dice-col">
              <div class="dice-val d-player" id="d-p">0</div>
              <span class="dice-label" style="color:var(--accent)">VOC√ä</span>
            </div>
            <div style="font-size:24px;color:#666">VS</div>
            <div class="dice-col">
              <div class="dice-val d-enemy" id="d-e">0</div>
              <span class="dice-label" style="color:var(--hp)">INIMIGO</span>
            </div>
          </div>
        </div>
      </div>
      
      <div id="ui-actions" class="grid-layout" style="grid-template-columns:1fr 1fr; margin-top:16px; gap:10px"></div>
      <div id="ui-log" class="log-area"></div>
    </div>

    <div class="panel">
      <div class="title">Local</div>
      <div style="text-align:center; padding:15px; background:rgba(0,0,0,0.3); border-radius:8px; border:1px dashed var(--border)">
        <div id="ui-loc-emoji" style="font-size:40px"></div>
        <div id="ui-loc-name" style="font-weight:900; font-size:18px"></div>
        <div id="ui-loc-desc" style="font-size:12px; opacity:0.7"></div>
      </div>
      <div class="title" style="margin-top:24px">Miss√µes</div>
      <div id="ui-quests" class="quest-box"></div>
    </div>
  </div>
</div>

<div id="modal-overlay" class="modal-overlay">
  <div class="modal-box">
    <div class="row between title">
      <span id="modal-title">T√≠tulo</span>
      <button class="btn" onclick="UI.closeModal()">‚úï</button>
    </div>
    <div id="modal-content"></div>
  </div>
</div>

<script>
// --- CONFIGURA√á√ÉO FIREBASE ---
// PARA ATIVAR O ONLINE REAL:
// 1. Crie um projeto no firebase.google.com
// 2. Crie um banco Firestore em "Test Mode".
// 3. Copie as chaves do seu projeto e cole abaixo.
const firebaseConfig = {
  // apiKey: "SUA_API_KEY_AQUI",
  // authDomain: "SEU_PROJETO.firebaseapp.com",
  // projectId: "SEU_PROJETO_ID",
  // storageBucket: "SEU_PROJETO.appspot.com",
  // messagingSenderId: "NUMERO",
  // appId: "APP_ID"
};

let db = null;
try {
  if(firebaseConfig.apiKey) {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    console.log("Firebase Conectado!");
  }
} catch(e) { console.log("Modo Offline (Sem Firebase)"); }

// --- L√ìGICA DO RANKING ---
const Ranking = {
  open: async () => {
    const ct = document.getElementById('modal-content');
    const tt = document.getElementById('modal-title');
    document.getElementById('modal-overlay').style.display = 'flex';
    tt.innerText = 'üèÜ Ranking de Lendas';
    ct.innerHTML = '<div style="text-align:center; padding:20px">Carregando Campe√µes...</div>';
    
    let scores = [];

    // Tenta pegar do Firebase
    if(db) {
      try {
        const snap = await db.collection("scores").orderBy("lvl", "desc").limit(10).get();
        snap.forEach(doc => scores.push(doc.data()));
      } catch(e) { console.log("Erro no DB", e); }
    } else {
      // DADOS MOCKADOS (SIMULA√á√ÉO PARA QUANDO N√ÉO TIVER INTERNET/CONFIG)
      scores = [
        { name: "Lenda_Do_RPG", lvl: 50, gold: 99999 },
        { name: "MatadorDeDrag√£o", lvl: 42, gold: 50000 },
        { name: "MagoSupremo", lvl: 35, gold: 12000 },
        { name: "GuerreiroZ", lvl: 20, gold: 5000 },
        { name: "NoobMaster", lvl: 5, gold: 100 }
      ];
      // Adiciona o jogador atual para compara√ß√£o
      scores.push({ name: State.p.name + " (Voc√™)", lvl: State.p.lvl, gold: State.p.gold });
      scores.sort((a,b) => b.lvl - a.lvl);
    }

    let html = `<div style="display:flex; flex-direction:column; gap:8px">`;
    html += `<div style="text-align:center; margin-bottom:10px; font-size:12px; color:#888">${db ? 'üü¢ Conectado √† Nuvem' : 'üî¥ Modo Offline (Simula√ß√£o)'}</div>`;
    
    scores.forEach((s, i) => {
      let icon = 'üë§';
      if(i===0) icon = 'üëë'; else if(i===1) icon = 'ü•à'; else if(i===2) icon = 'ü•â';
      html += `
        <div class="rank-row" style="${s.name.includes('(Voc√™)')?'border-color:var(--accent); background:rgba(56,189,248,0.1)':''}">
          <div style="width:30px">${icon}</div>
          <div style="flex:1">${s.name}</div>
          <div style="width:100px; text-align:right">Lvl ${s.lvl} <span style="color:var(--gold)">(${s.gold}ü™ô)</span></div>
        </div>`;
    });
    
    html += `</div>`;
    html += `<div style="margin-top:20px; border-top:1px solid #444; padding-top:10px;">
      <input type="text" id="rank-name" placeholder="Seu Nick" value="${State.p.name}" style="background:#111; color:#fff; border:1px solid #555; padding:8px; width:60%">
      <button class="btn" style="display:inline-flex" onclick="Ranking.save()">Salvar Score</button>
    </div>`;
    
    ct.innerHTML = html;
  },

  save: async () => {
    const nick = document.getElementById('rank-name').value || "An√¥nimo";
    State.p.name = nick;
    Core.save();
    
    if(db) {
      try {
        await db.collection("scores").add({
          name: nick,
          lvl: State.p.lvl,
          gold: State.p.gold,
          date: new Date()
        });
        alert("Score salvo na nuvem!");
        Ranking.open(); // Recarrega
      } catch(e) { alert("Erro ao salvar online."); }
    } else {
      alert("Score salvo localmente! (Configure o Firebase para salvar online)");
    }
  }
};

const DB = {
  classes: {
    warrior: { name:'Guerreiro', e:'‚öîÔ∏è', hp:150, mp:20, str:4, agi:1, int:1, desc:'Forte e Resistente.' },
    rogue:   { name:'Ladino',    e:'üó°Ô∏è', hp:110, mp:40, str:2, agi:5, int:2, desc:'Mestre da Agilidade.' },
    mage:    { name:'Mago',      e:'üîÆ', hp:80,  mp:100,str:1, agi:2, int:5, desc:'Poder M√°gico.' },
    paladin: { name:'Paladino',  e:'üõ°Ô∏è', hp:140, mp:50, str:3, agi:1, int:3, desc:'Defesa e Cura.' }
  },
  maps: {
    town:      { name:'Vila',       e:'üèòÔ∏è', lvl:1,  theme:'town', type:'safe', desc:'Zona Segura.' },
    forest:    { name:'Floresta',   e:'üå≤', lvl:1,  theme:'forest', type:'combat', mobs:['rat','wolf','thief'], desc:'N√≠vel 1-4' },
    cave:      { name:'Caverna',    e:'üï∏Ô∏è', lvl:5,  theme:'cave', type:'combat', mobs:['bat','spider','orc'], desc:'N√≠vel 5-9' },
    graveyard: { name:'Cemit√©rio',  e:'‚ö∞Ô∏è', lvl:10, theme:'graveyard', type:'combat', mobs:['skel','zombie','ghost'], desc:'N√≠vel 10-14' },
    volcano:   { name:'Vulc√£o',     e:'üåã', lvl:15, theme:'volcano', type:'combat', mobs:['imp','golem','dragon'], desc:'N√≠vel 15-19' },
    void:      { name:'O Vazio',    e:'üåå', lvl:20, theme:'void', type:'combat', mobs:['shadow','voidking'], desc:'N√≠vel 20+' }
  },
  mobs: {
    rat:    { name:'Rato',      e:'üêÄ', hp:30,  agi:1, atk:5,  xp:10,  gold:5 },
    wolf:   { name:'Lobo',      e:'üê∫', hp:50,  agi:4, atk:8,  xp:20,  gold:10 },
    thief:  { name:'Bandido',   e:'ü•∑', hp:60,  agi:6, atk:10, xp:30,  gold:18 },
    bat:    { name:'Morcego',   e:'ü¶á', hp:50,  agi:8, atk:8,  xp:35,  gold:12 },
    spider: { name:'Aranha',    e:'üï∑Ô∏è', hp:80,  agi:7, atk:12, xp:50,  gold:22 },
    orc:    { name:'Orc',       e:'üëπ', hp:120, agi:3, atk:16, xp:70,  gold:35 },
    skel:   { name:'Esqueleto', e:'üíÄ', hp:100, agi:5, atk:18, xp:90,  gold:40 },
    zombie: { name:'Zumbi',     e:'üßü', hp:150, agi:2, atk:22, xp:110, gold:45 },
    ghost:  { name:'Fantasma',  e:'üëª', hp:110, agi:10,atk:25, xp:130, gold:55 },
    imp:    { name:'Diabrete',  e:'üëø', hp:140, agi:12,atk:28, xp:160, gold:65 },
    golem:  { name:'Golem',     e:'üóø', hp:300, agi:0, atk:40, xp:250, gold:120 },
    dragon: { name:'Drag√£o',    e:'üêâ', hp:400, agi:6, atk:55, xp:500, gold:400, boss:true },
    shadow: { name:'Sombra',    e:'üë§', hp:350, agi:15,atk:60, xp:600, gold:250 },
    voidking:{name:'Rei Vazio', e:'üëë', hp:1000,agi:8, atk:95, xp:5000,gold:5000, boss:true }
  },
  items: {
    pot:  { name:'Po√ß√£o P.', e:'üß™', val:25, effect:p=>p.hp=Math.min(p.maxHp, p.hp+60), desc:'+60 HP' },
    mega: { name:'Mega Po√ß√£o',e:'üç∑', val:100, effect:p=>p.hp=Math.min(p.maxHp, p.hp+150), desc:'+150 HP' },
    elixir:{ name:'Elixir',   e:'üåü', val:300, effect:p=>{p.hp=p.maxHp;p.mp=p.maxMp}, desc:'FULL HP/MP' },
    ether:{ name:'√âter Mana', e:'üî∑', val:25, effect:p=>p.mp=Math.min(p.maxMp, p.mp+40), desc:'+40 MP' },
    bomb: { name:'Bomba',     e:'üí£', val:50, dmg:50, desc:'50 Dano Fixo' }
  },
  // GEAR
  gear: {
    weapons: {
      warrior: [{n:'Punhos',v:1,x:3},{n:'Espada Ferruja',v:5,x:8,c:100},{n:'Espada Ferro',v:10,x:15,c:350},{n:'Montante',v:15,x:25,c:900},{n:'Matadora',v:25,x:40,c:2500},{n:'Excalibur',v:50,x:70,c:8000}],
      rogue:   [{n:'Punhos',v:1,x:3},{n:'Adaga Cega',v:4,x:7,c:100},{n:'Adaga Dupla',v:8,x:14,c:350},{n:'L√¢mina Sombra',v:12,x:22,c:900},{n:'Presa Veneno',v:20,x:35,c:2500},{n:'Fim dos Dias',v:45,x:65,c:8000}],
      mage:    [{n:'M√£os',v:1,x:3},{n:'Varinha Pau',v:4,x:8,c:100},{n:'Cajado Aprendiz',v:8,x:14,c:350},{n:'Cajado R√∫nico',v:14,x:24,c:900},{n:'Cetro Vazio',v:22,x:38,c:2500},{n:'Cosmos',v:48,x:68,c:8000}],
      paladin: [{n:'Punhos',v:1,x:3},{n:'Ma√ßa Madeira',v:4,x:7,c:100},{n:'Martelo Ferro',v:9,x:14,c:350},{n:'Mangual',v:13,x:23,c:900},{n:'Martelo Luz',v:23,x:38,c:2500},{n:'Mjolnir',v:48,x:68,c:8000}]
    },
    armors: {
      warrior: [{n:'Camisa',v:0},{n:'Couro Batido',v:3,c:100},{n:'Cota Malha',v:7,c:350},{n:'Peitoral A√ßo',v:14,c:900},{n:'Placas Drag√£o',v:22,c:2500},{n:'Armadura Deus',v:35,c:8000}],
      rogue:   [{n:'Camisa',v:0},{n:'Capa Viagem',v:2,c:100},{n:'Couro Fino',v:6,c:350},{n:'Manto Sombra',v:12,c:900},{n:'Traje Ninja',v:20,c:2500},{n:'Vulto',v:32,c:8000}],
      mage:    [{n:'Camisa',v:0},{n:'T√∫nica Velha',v:1,c:100},{n:'Robe Aprendiz',v:5,c:350},{n:'Manto Arcano',v:10,c:900},{n:'Toga Estelar',v:18,c:2500},{n:'Tecido Tempo',v:30,c:8000}],
      paladin: [{n:'Camisa',v:0},{n:'Gib√£o',v:3,c:100},{n:'Escudo Torre',v:8,c:350},{n:'Armadura Bento',v:15,c:900},{n:'Placas Luz',v:24,c:2500},{n:'√âgide',v:38,c:8000}]
    }
  },
  quests: [
    { id:'q1', target:'rat', count:5, title:'Praga de Ratos', reward_g:100, reward_xp:100 },
    { id:'q2', target:'wolf', count:10, title:'Peles de Lobo', reward_g:200, reward_xp:250 },
    { id:'q3', target:'orc', count:8, title:'Limpar Caverna', reward_g:400, reward_xp:500 },
    { id:'q4', target:'skel', count:15, title:'Ex√©rcito de Ossos', reward_g:800, reward_xp:1000 },
    { id:'q5', target:'golem', count:5, title:'N√∫cleos de Magma', reward_g:2000, reward_xp:2500 },
    { id:'q6', target:'dragon', count:1, title:'O Drag√£o Anci√£o', reward_g:5000, reward_xp:5000 }
  ],
  skills: {
    bash: { name:'Golpe', cost:5, bonus:5, dice:8 },
    stab: { name:'Furar', cost:5, bonus:3, dice:10 },
    fire: { name:'Fogo',  cost:10, bonus:8, dice:20 },
    heal: { name:'Cura',  cost:12, val:50, type:'heal' }
  },
  mounts: {
    horse: { name:'Cavalo', e:'üêé', cost:200, agi:2, str:0, desc:'+2 AGI (Barato e r√°pido)' },
    wolf:  { name:'Warg',   e:'üê∫', cost:600, agi:3, str:2, desc:'+3 AGI, +2 FOR (Agressivo)' },
    griff: { name:'Grifo',  e:'ü¶Ö', cost:1500, agi:5, str:3, int:3, desc:'+5 AGI, +3 FOR/INT' },
    dragon:{ name:'Draco',  e:'üêâ', cost:5000, agi:8, str:8, int:5, desc:'+8 AGI/FOR, +5 INT' }
  }
};

let State = {
  p: { name:'Her√≥i', class:null, lvl:1, xp:0, gold:0, hp:100, mp:50, maxHp:100, maxMp:50, wpn:0, arm:0, inv:{}, str:1, agi:1, int:1, points:0, mount:null },
  loc: 'town',
  combat: null,
  q: {}
};

const Dice = {
  d20: () => Math.floor(Math.random()*20)+1,
  roll: (min, max) => Math.floor(Math.random()*(max-min+1))+min
};

const getStats = () => {
  const p = State.p;
  let s = { str:p.str, agi:p.agi, int:p.int };
  if(p.mount && DB.mounts[p.mount]) {
    const m = DB.mounts[p.mount];
    s.str += (m.str||0); s.agi += (m.agi||0); s.int += (m.int||0);
  }
  return s;
};

const getGear = () => {
  const p = State.p;
  const c = p.class || 'warrior';
  const w = DB.gear.weapons[c][p.wpn] || DB.gear.weapons[c][0];
  const a = DB.gear.armors[c][p.arm] || DB.gear.armors[c][0];
  return { w, a };
};

const UI = {
  render: () => {
    const p = State.p;
    const c = DB.classes[p.class];
    const stats = getStats();
    const g = getGear();
    
    document.getElementById('ui-lvl').innerText = p.lvl;
    document.getElementById('ui-gold').innerText = p.gold;
    document.getElementById('ui-class').innerText = c ? c.name : '';
    
    document.getElementById('val-str').innerText = stats.str;
    document.getElementById('val-agi').innerText = stats.agi;
    document.getElementById('val-int').innerText = stats.int;
    
    const mBadge = document.getElementById('ui-mount');
    if(p.mount) {
      const m = DB.mounts[p.mount];
      document.getElementById('mnt-icon').innerText = m.e;
      document.getElementById('mnt-name').innerText = m.name;
      document.getElementById('mnt-desc').innerText = m.desc;
      mBadge.classList.remove('hidden');
    } else mBadge.classList.add('hidden');
    
    const ptsBtn = document.querySelectorAll('.stat-btn');
    const ptsBadge = document.getElementById('ui-points');
    if(p.points > 0) {
      ptsBadge.innerText = `+${p.points} PONTOS`;
      ptsBadge.style.display = 'block';
      ptsBtn.forEach(b => b.classList.remove('hidden'));
    } else {
      ptsBadge.style.display = 'none';
      ptsBtn.forEach(b => b.classList.add('hidden'));
    }

    const setBar = (id, cur, max) => {
      document.getElementById(`ui-${id}-txt`).innerText = `${Math.floor(cur)}/${max}`;
      document.getElementById(`bar-${id}`).style.width = Math.min(100, (cur/max)*100) + '%';
    };
    setBar('hp', p.hp, p.maxHp);
    setBar('mp', p.mp, p.maxMp);
    setBar('xp', p.xp, p.lvl*150);

    document.getElementById('ui-wpn-name').innerText = g.w.n;
    document.getElementById('ui-wpn-dmg').innerText = `${g.w.v}-${g.w.x} dmg`;
    document.getElementById('ui-arm-name').innerText = g.a.n;
    document.getElementById('ui-arm-def').innerText = `+${g.a.v} def`;

    const hud = document.getElementById('enemy-hud');
    if(State.combat) {
      hud.style.opacity = '1';
      const e = State.combat.e;
      const pct = Math.max(0, Math.min(100, (e.hp/e.maxHp)*100));
      document.getElementById('enemy-hp-bar').style.width = pct + '%';
    } else hud.style.opacity = '0';

    const qBox = document.getElementById('ui-quests');
    qBox.innerHTML = '';
    DB.quests.forEach(q => {
      const cur = State.q[q.target] || 0; 
      const claimed = cur === 'done';
      const val = claimed ? q.count : cur;
      const ready = !claimed && val >= q.count;
      
      let html = `<div class="quest-card ${claimed?'done':(ready?'ready':'')}">`;
      html += `<div><span>${claimed?'‚úÖ':(ready?'‚≠ê':'‚¨ú')} <b>${q.title}</b></span><br><small>(${DB.mobs[q.target].e}) ${Math.min(val,q.count)}/${q.count}</small></div>`;
      if(ready) html += `<button class="btn btn-sm" style="background:var(--gold);color:#000" onclick="Core.claimQuest('${q.id}')">RESGATAR</button>`;
      html += `</div>`;
      qBox.innerHTML += html;
    });
  },

  log: (msg, type='') => {
    const box = document.getElementById('ui-log');
    const div = document.createElement('div');
    div.className = `log-line ${type}`;
    div.innerHTML = msg;
    box.prepend(div);
  },

  rollDuelAnim: (pVal, eVal, callback) => {
    const overlay = document.getElementById('dice-overlay');
    const pDie = document.getElementById('d-p');
    const eDie = document.getElementById('d-e');
    const msg = document.getElementById('dice-msg');
    overlay.style.display = 'flex';
    msg.innerText = "ROLANDO DADOS...";
    pDie.className = "dice-val d-player dice-shake";
    eDie.className = "dice-val d-enemy dice-shake";
    
    let rolls = 0;
    const interval = setInterval(() => {
      pDie.innerText = Math.floor(Math.random()*20)+1;
      eDie.innerText = Math.floor(Math.random()*20)+1;
      rolls++;
      if(rolls > 12) {
        clearInterval(interval);
        pDie.innerText = pVal;
        eDie.innerText = eVal;
        pDie.classList.remove('dice-shake'); eDie.classList.remove('dice-shake');
        
        if(pVal >= eVal) {
          pDie.classList.add('winner'); eDie.classList.add('loser');
          msg.innerText = "VOC√ä VENCEU!"; msg.style.color = "var(--xp)";
        } else {
          eDie.classList.add('winner'); pDie.classList.add('loser');
          msg.innerText = "INIMIGO VENCEU!"; msg.style.color = "var(--hp)";
        }
        setTimeout(() => {
          overlay.style.display = 'none';
          pDie.classList.remove('winner','loser'); eDie.classList.remove('winner','loser');
          callback();
        }, 800);
      }
    }, 60);
  },

  fxFloat: (txt, type) => {
    const el = document.createElement('div');
    el.className = 'dmg-pop'; el.innerHTML = txt;
    el.style.color = type==='crit'?'var(--crit)':(type==='miss'?'#888':(type==='bad'?'var(--hp)':'#fff'));
    el.style.left = (30 + Math.random()*40) + '%';
    el.style.top = (30 + Math.random()*20) + '%';
    document.getElementById('game-screen').appendChild(el);
    setTimeout(()=>el.remove(), 1000);
  },

  setScreen: (emoji) => {
    document.getElementById('ui-main-emoji').innerText = emoji;
  },
  
  openModal: (type) => {
    const ct = document.getElementById('modal-content');
    const tt = document.getElementById('modal-title');
    document.getElementById('modal-overlay').style.display = 'flex';
    ct.innerHTML = '';
    
    if(type === 'class') {
      tt.innerText = 'Escolha sua Classe';
      for(let k in DB.classes) {
        const c = DB.classes[k];
        ct.innerHTML += `<div class="card-item" onclick="Core.setClass('${k}')">
          <div class="row"><span style="font-size:32px">${c.e}</span> <div><b>${c.name}</b><br><small>${c.desc}</small></div></div>
        </div>`;
      }
    } 
    else if(type === 'map') {
      tt.innerText = 'Mundo';
      for(let k in DB.maps) {
        const m = DB.maps[k];
        const locked = State.p.lvl < m.lvl;
        ct.innerHTML += `<div class="card-item" style="opacity:${locked?0.5:1}" onclick="${locked?'':'Core.travel(\''+k+'\')'}">
          <div class="row"><span style="font-size:24px">${m.e}</span> <div><b>${m.name}</b><br><small>${m.desc}</small></div></div>
          ${locked ? '<small>üîí Nvl '+m.lvl+'</small>' : '<b>IR ‚ûî</b>'}
        </div>`;
      }
    }
    else if(type === 'inv') {
      tt.innerText = 'Invent√°rio';
      for(let k in State.p.inv) {
        if(State.p.inv[k]>0) {
          const it = DB.items[k];
          ct.innerHTML += `<div class="card-item" onclick="Core.useItem('${k}')">
            <span>${it.e} ${it.name} (x${State.p.inv[k]})</span> <b>USAR</b>
          </div>`;
        }
      }
      if(!ct.innerHTML) ct.innerHTML = '<div style="text-align:center;color:#666">Vazio.</div>';
    }
    else if(type === 'reward') {
      tt.innerText = 'Recompensa!';
      ct.innerHTML = `<div style="text-align:center">
        <div style="font-size:60px">üéÅ</div>
        <h3>Miss√£o Completa!</h3>
        <p>Voc√™ ganhou:</p>
        <div style="font-size:20px; color:var(--gold); margin:10px">ü™ô ${State.tempReward.g} Ouro</div>
        <div style="font-size:20px; color:var(--xp); margin:10px">‚ú® ${State.tempReward.x} XP</div>
        <button class="btn btn-big" onclick="UI.closeModal()">Legal!</button>
      </div>`;
    }
  },
  closeModal: () => document.getElementById('modal-overlay').style.display = 'none'
};

const Core = {
  init: () => {
    const s = localStorage.getItem('rpg_v10_final');
    if(s) { State = JSON.parse(s); Core.travel(State.loc); UI.log('Jogo carregado.'); } 
    else { UI.openModal('class'); }
    UI.render();
  },
  save: () => { localStorage.setItem('rpg_v10_final', JSON.stringify(State)); UI.render(); },
  resetGame: () => { if(confirm('Apagar tudo?')){ localStorage.removeItem('rpg_v10_final'); location.reload(); } },

  setClass: (k) => {
    const c = DB.classes[k];
    State.p.class = k;
    Object.assign(State.p, { maxHp:c.hp, hp:c.hp, maxMp:c.mp, mp:c.mp, str:c.str, agi:c.agi, int:c.int, mount:null, wpn:0, arm:0 });
    State.p.inv = { pot:3 };
    UI.closeModal(); Core.travel('town');
  },

  addStat: (stat) => {
    if(State.p.points > 0) {
      State.p[stat]++; State.p.points--;
      if(stat==='int') State.p.maxMp += 10;
      UI.log(`Aumentou ${stat.toUpperCase()}!`);
      Core.save();
    }
  },

  travel: (id) => {
    State.loc = id; State.combat = null;
    UI.closeModal();
    const map = DB.maps[id];
    UI.setScreen(map.e);
    document.body.className = `theme-${map.theme}`;
    document.getElementById('ui-loc-emoji').innerText = map.e;
    document.getElementById('ui-loc-name').innerText = map.name;
    document.getElementById('ui-loc-desc').innerText = map.desc;
    
    const area = document.getElementById('ui-actions');
    area.innerHTML = '';
    
    if(map.type === 'safe') {
      area.innerHTML = `
        <button class="btn btn-big" onclick="Core.rest()">üõå Descansar</button>
        <button class="btn btn-big" onclick="Core.openShop()">üí∞ Mercador</button>
        <button class="btn btn-big" style="border-color:var(--xp)" onclick="UI.openModal('map')">üó∫Ô∏è Viajar</button>
      `;
    } else {
      area.innerHTML = `
        <button class="btn btn-big" onclick="Core.explore()">üé≤ Explorar</button>
        <button class="btn btn-big" onclick="Core.travel('town')">üèÉ Fugir</button>
      `;
    }
    Core.save();
  },

  rest: () => {
    State.p.hp = State.p.maxHp; State.p.mp = State.p.maxMp;
    UI.log('Recuperado.', 'color:#aaa'); Core.save();
  },

  explore: () => {
    const map = DB.maps[State.loc];
    if(Math.random() < 0.20) { 
      const g = Dice.roll(2, 6) * map.lvl;
      State.p.gold += g;
      UI.log(`Achou ${g} ouro.`);
      UI.fxFloat(`+${g}ü™ô`, 'crit');
      Core.save();
    } else {
      const mobs = map.mobs;
      const key = mobs[Math.floor(Math.random()*mobs.length)];
      Core.startCombat(key);
    }
  },

  startCombat: (key) => {
    const m = DB.mobs[key];
    State.combat = { e: { ...m, maxHp:m.hp }, turn: 0 };
    UI.setScreen(m.e);
    UI.log(`‚öîÔ∏è <b>${m.name}</b> apareceu!`, 'color:var(--dmg)');
    Core.renderBtns(false);
  },

  renderBtns: (disabled) => {
    const area = document.getElementById('ui-actions');
    let sk = 'bash';
    if(State.p.class === 'rogue') sk = 'stab';
    if(State.p.class === 'mage') sk = 'fire';
    if(State.p.class === 'paladin') sk = 'heal';
    const sData = DB.skills[sk];

    area.innerHTML = `
      <button class="btn btn-big" ${disabled?'disabled':''} onclick="Core.act('atk')">‚öîÔ∏è Duelo</button>
      <button class="btn btn-big" ${disabled?'disabled':''} onclick="Core.act('skill','${sk}')" style="color:var(--mp)">‚ú® ${sData.name} (${sData.cost})</button>
      <button class="btn btn-big" ${disabled?'disabled':''} onclick="UI.openModal('inv')">üéí Item</button>
      <button class="btn btn-big" ${disabled?'disabled':''} onclick="Core.travel('town')">üèÉ Fugir</button>
    `;
  },

  act: (type, skKey) => {
    if(!State.combat) return;
    const p = State.p;
    if(type === 'skill') {
      if(p.mp < DB.skills[skKey].cost) { UI.log('Sem mana!'); return; }
      p.mp -= DB.skills[skKey].cost;
    }
    
    const stats = getStats();
    // DUELO: D20 + AGI Total/2
    const pRoll = Dice.d20() + Math.floor(stats.agi/2);
    const eRoll = Dice.d20(); 
    
    Core.renderBtns(true);
    UI.rollDuelAnim(pRoll, eRoll, () => {
      Core.resolveDuel(pRoll, eRoll, type, skKey);
    });
  },

  resolveDuel: (pRoll, eRoll, type, skKey) => {
    const p = State.p;
    const e = State.combat.e;
    const gear = getGear();
    const stats = getStats();
    
    if(pRoll >= eRoll) {
      if(type === 'atk') {
        let attr = p.class === 'mage' ? stats.int : stats.str;
        let dmg = Dice.roll(gear.w.v, gear.w.x) + attr + Math.floor(p.lvl/2);
        
        if(pRoll >= 20) { dmg = Math.floor(dmg*1.5); UI.fxFloat('CRIT!','crit'); }
        e.hp -= dmg;
        UI.log(`Causou <b>${dmg}</b> dano.`);
        UI.fxFloat(dmg, '#fff');
      } 
      else if(type === 'skill') {
        const s = DB.skills[skKey];
        if(s.type === 'heal') {
          let heal = s.val + (stats.int * 2);
          p.hp = Math.min(p.maxHp, p.hp + heal);
          UI.log(`Curou ${heal} HP.`);
          UI.fxFloat('‚ù§','crit');
        } else {
          let base = Dice.roll(1, s.dice) + s.bonus + (stats.int * 2);
          e.hp -= base;
          UI.log(`‚ú® ${s.name}: <b>${base}</b> dano.`);
          UI.fxFloat(base,'var(--mp)');
        }
      }
    } else {
      UI.log(`‚ùå Inimigo venceu o duelo!`, 'color:var(--hp)');
      const armor = gear.a.v;
      let dmg = Math.max(0, (e.atk + Dice.roll(-2, 2)) - armor);
      p.hp -= dmg;
      if(dmg > 0) {
        UI.fxFloat(`-${dmg}`,'bad');
        document.getElementById('game-screen').style.animation = 'shake 0.3s';
        setTimeout(()=>document.getElementById('game-screen').style.animation='',300);
      } else {
        UI.log('Armadura bloqueou.');
        UI.fxFloat('BLOK','miss');
      }
    }

    if(e.hp <= 0) Core.win();
    else if(p.hp <= 0) {
      UI.log('üíÄ VOC√ä MORREU...', 'color:red');
      p.hp = 1; p.gold = Math.floor(p.gold/2);
      Core.travel('town');
    } else {
      Core.renderBtns(false);
    }
    Core.save();
  },

  win: () => {
    const e = State.combat.e;
    UI.log(`üèÜ Vit√≥ria! +${e.xp}XP +${e.gold} Ouro`);
    State.p.gold += e.gold;
    State.p.xp += e.xp;
    
    let key = Object.keys(DB.mobs).find(k => DB.mobs[k].name === e.name);
    if(key && State.q[key] !== 'done') {
      State.q[key] = (State.q[key]||0) + 1;
    }

    if(State.p.xp >= State.p.lvl * 150) {
      State.p.xp = 0; State.p.lvl++;
      State.p.points += 3;
      State.p.maxHp += 10; State.p.hp = State.p.maxHp;
      UI.log(`üÜô LEVEL UP! +3 Pontos!`);
      UI.fxFloat('LEVEL UP!','crit');
    }

    State.combat = null;
    UI.setScreen(e.e);
    setTimeout(() => {
      Core.travel(State.loc);
    }, 1200);
  },

  claimQuest: (qid) => {
    const q = DB.quests.find(x => x.id === qid);
    if(q) {
      State.q[q.target] = 'done';
      State.p.gold += q.reward_g;
      State.p.xp += q.reward_xp;
      State.tempReward = { g:q.reward_g, x:q.reward_xp };
      UI.openModal('reward');
      Core.save();
    }
  },

  useItem: (k) => {
    if(State.p.inv[k]>0) {
      State.p.inv[k]--;
      const it = DB.items[k];
      if(it.dmg) {
        if(!State.combat) return;
        State.combat.e.hp -= it.dmg;
        UI.log(`Bomba: ${it.dmg} dano!`);
        if(State.combat.e.hp<=0) Core.win();
      } else {
        it.effect(State.p);
        UI.log(`Usou ${it.name}.`);
      }
      UI.closeModal(); Core.save();
    }
  },

  openShop: () => {
    const ct = document.getElementById('modal-content');
    const tt = document.getElementById('modal-title');
    document.getElementById('modal-overlay').style.display = 'flex';
    tt.innerText = 'Mercador';
    ct.innerHTML = `
      <div class="tab-menu">
        <div class="tab-btn active" onclick="Core.renderShopTab('items')">Itens</div>
        <div class="tab-btn" onclick="Core.renderShopTab('gear')">Equip</div>
        <div class="tab-btn" onclick="Core.renderShopTab('mounts')">Mounts</div>
      </div>
      <div id="shop-body"></div>
    `;
    Core.renderShopTab('items');
  },

  renderShopTab: (tab) => {
    document.querySelectorAll('.tab-btn').forEach(b => {
      b.classList.toggle('active', b.innerText.toLowerCase().includes(tab==='gear'?'equip':tab));
    });

    const body = document.getElementById('shop-body');
    body.innerHTML = '';
    const p = State.p;
    
    if(tab === 'items') {
      for(let k in DB.items) {
        const it = DB.items[k];
        if(!it.dmg || k==='bomb') body.innerHTML += `<div class="card-item" onclick="Core.buy('item','${k}')"><span>${it.e} ${it.name} <small>${it.desc}</small></span> <b>${it.val}ü™ô</b></div>`;
      }
    }
    else if(tab === 'gear') {
      const c = p.class;
      const nw = DB.gear.weapons[c][p.wpn+1];
      if(nw) body.innerHTML += `<div class="card-item" onclick="Core.buy('wpn')"><span>‚öîÔ∏è ${nw.n} (${nw.v}-${nw.x})</span> <b>${nw.c}ü™ô</b></div>`;
      else body.innerHTML += `<div class="card-item"><span>‚öîÔ∏è Arma M√°xima!</span></div>`;
      
      const na = DB.gear.armors[c][p.arm+1];
      if(na) body.innerHTML += `<div class="card-item" onclick="Core.buy('arm')"><span>üõ°Ô∏è ${na.n} (+${na.v})</span> <b>${na.c}ü™ô</b></div>`;
      else body.innerHTML += `<div class="card-item"><span>üõ°Ô∏è Armadura M√°xima!</span></div>`;
    }
    else if(tab === 'mounts') {
      for(let k in DB.mounts) {
        const m = DB.mounts[k];
        const owned = p.mount === k;
        body.innerHTML += `<div class="card-item" style="${owned?'border:1px solid var(--gold)':''}" onclick="Core.buy('mount','${k}')">
          <div class="row"><span style="font-size:24px">${m.e}</span> <div><b>${m.name}</b><br><small>${m.desc}</small></div></div>
          ${owned ? '<b>‚úÖ</b>' : `<b>${m.cost}ü™ô</b>`}
        </div>`;
      }
    }
  },

  buy: (type, k) => {
    const p = State.p;
    if(type === 'item') {
      const it = DB.items[k];
      if(p.gold >= it.val) { p.gold-=it.val; p.inv[k]=(p.inv[k]||0)+1; UI.log('Comprou item.'); }
    } 
    else if(type === 'mount') {
      const m = DB.mounts[k];
      if(p.mount === k) { UI.log('J√° possui.'); return; }
      if(p.gold >= m.cost) { p.gold-=m.cost; p.mount=k; UI.log(`Comprou ${m.name}!`); Core.renderShopTab('mounts'); }
    }
    else {
      // Gear System 2.0
      const c = p.class;
      const list = type==='wpn' ? DB.gear.weapons[c] : DB.gear.armors[c];
      const idx = type==='wpn' ? p.wpn : p.arm;
      const it = list[idx+1];
      
      if(it && p.gold >= it.c) {
        p.gold -= it.c;
        if(type==='wpn') p.wpn++; else p.arm++;
        UI.log('Upgrade comprado!');
        Core.renderShopTab('gear');
      } else {
        UI.log('Ouro insuficiente.');
      }
    }
    Core.save();
  }
};

Core.init();
</script>
</body>
</html>
